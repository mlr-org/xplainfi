<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Perturbation-based Feature Importance Methods • xplainfi</title>
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Roboto-0.4.10/font.css" rel="stylesheet">
<link href="../deps/JetBrains_Mono-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Roboto_Slab-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Perturbation-based Feature Importance Methods">
<script defer src="https://umami.jemu.name/script.js" data-website-id="248c8668-4908-4c63-86f7-db0a1b19758a"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">xplainfi</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/xplainfi.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><h6 class="dropdown-header" data-toc-skip>Method Showcase</h6></li>
    <li><a class="dropdown-item" href="../articles/perturbation-importance.html">Perturbation-Based Methods (PFI, CFI, RFI)</a></li>
    <li><a class="dropdown-item" href="../articles/loco.html">Model Refitting Measures (LOCO, WVIM)</a></li>
    <li><a class="dropdown-item" href="../articles/sage-methods.html">Shapley Additive Global Importance (SAGE)</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Specialized Topics</h6></li>
    <li><a class="dropdown-item" href="../articles/feature-samplers.html">Feature Samplers</a></li>
    <li><a class="dropdown-item" href="../articles/inference.html">Inference for Feature Importances</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Testing &amp; Validation</h6></li>
    <li><a class="dropdown-item" href="../articles/simulation-settings.html">Simulation Settings</a></li>
    <li><a class="dropdown-item" href="../articles/fippy-comparison.html">Comparison with fippy (Python)</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mlr-org/xplainfi/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<link href="perturbation-importance_files/htmltools-fill-0.5.9/fill.css" rel="stylesheet">
<script src="perturbation-importance_files/htmlwidgets-1.6.4/htmlwidgets.js"></script><script src="perturbation-importance_files/viz-1.8.2/viz.js"></script><link href="perturbation-importance_files/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="perturbation-importance_files/grViz-binding-1.0.11/grViz.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Perturbation-based Feature Importance Methods</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mlr-org/xplainfi/blob/main/vignettes/articles/perturbation-importance.Rmd" class="external-link"><code>vignettes/articles/perturbation-importance.Rmd</code></a></small>
      <div class="d-none name"><code>perturbation-importance.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr-org.github.io/xplainfi/" class="external-link">xplainfi</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3.mlr-org.com" class="external-link">mlr3</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3learners.mlr-org.com" class="external-link">mlr3learners</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rich-iannone.github.io/DiagrammeR/" class="external-link">DiagrammeR</a></span><span class="op">)</span></span></code></pre></div>
<p>This vignette demonstrates the three perturbation-based feature
importance methods implemented in xplainfi:</p>
<ul>
<li>
<strong>PFI (Permutation Feature Importance)</strong>: Uses marginal
sampling (simple permutation)</li>
<li>
<strong>CFI (Conditional Feature Importance)</strong>: Uses
conditional sampling via Adversarial Random Forests</li>
<li>
<strong>RFI (Relative Feature Importance)</strong>: Uses conditional
sampling on a user-specified subset of features</li>
</ul>
<p>We’ll demonstrate these methods using three carefully designed
scenarios that highlight their key differences.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Common setup for all scenarios</span></span>
<span><span class="va">learner</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">lrn</a></span><span class="op">(</span><span class="st">"regr.ranger"</span>, num.trees <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">resampling</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">measure</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">msr</a></span><span class="op">(</span><span class="st">"regr.mse"</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="scenario-1-interaction-effects">Scenario 1: Interaction Effects<a class="anchor" aria-label="anchor" href="#scenario-1-interaction-effects"></a>
</h2>
<p>This scenario demonstrates how marginal methods (PFI) can miss
important interaction effects that conditional methods (CFI)
capture:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate interaction scenario</span></span>
<span><span class="va">task_int</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_dgp_scenarios.html">sim_dgp_interactions</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">data_int</span> <span class="op">&lt;-</span> <span class="va">task_int</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><strong>Causal Structure:</strong></p>
<div class="grViz html-widget html-fill-item" id="htmlwidget-ac96cb3ee4656e2e9ec3" style="width:768px;height:384px;"></div>
<script type="application/json" data-for="htmlwidget-ac96cb3ee4656e2e9ec3">{"x":{"diagram":"\ndigraph interaction_dag {\n  rankdir=TB;\n  node [shape=circle, style=filled, fontname=\"Arial\", fontsize=12];\n  \n  # Feature nodes\n  x1 [fillcolor=\"lightblue\", label=\"x1\"];\n  x2 [fillcolor=\"lightblue\", label=\"x2\"];  \n  x3 [fillcolor=\"lightblue\", label=\"x3\"];\n  # noise1 [fillcolor=\"lightgray\", label=\"noise1\"];\n  # noise2 [fillcolor=\"lightgray\", label=\"noise2\"];\n  \n  # Interaction node\n  interaction [fillcolor=\"yellow\", label=\"x1×x2\", shape=diamond];\n  \n  # Outcome\n  y [fillcolor=\"greenyellow\", label=\"y\"];\n  \n  # NO direct effects from x1 and x2\n  x3 -> y [label=\"1.0\", color=\"blue\"];\n  \n  # Pure interaction effect\n  x1 -> interaction [style=dashed];\n  x2 -> interaction [style=dashed];\n  interaction -> y [label=\"2.0\", color=\"red\", penwidth=3];\n  \n  # Layout\n  {rank=same; x1, x2, x3, noise1, noise2}\n  {rank=same; interaction}\n}\n","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script><p>The key insight: x1 and x2 have <strong>NO direct effects</strong> -
they affect y ONLY through their interaction (thick red arrow). However,
PFI will still show them as important because permuting either feature
destroys the crucial interaction term.</p>
<div class="section level3">
<h3 id="analysis">Analysis<a class="anchor" aria-label="anchor" href="#analysis"></a>
</h3>
<p>Let’s analyze the interaction scenario where <span class="math inline">\(y = 2 \cdot x_1 \cdot x_2 + x_3 +
\epsilon\)</span>. Note that x1 and x2 have NO main effects.</p>
<div class="section level4">
<h4 id="pfi-on-interactions">PFI on Interactions<a class="anchor" aria-label="anchor" href="#pfi-on-interactions"></a>
</h4>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pfi_int</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/PFI.html">PFI</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task_int</span>,</span>
<span>    learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>    measure <span class="op">=</span> <span class="va">measure</span>,</span>
<span>    resampling <span class="op">=</span> <span class="va">resampling</span>,</span>
<span>    n_repeats <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute importance scores</span></span>
<span><span class="va">pfi_int</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">pfi_int</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span>relation <span class="op">=</span> <span class="st">"difference"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;    feature  importance</span></span>
<span><span class="co">#&gt;     &lt;char&gt;       &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:  noise1 0.003847893</span></span>
<span><span class="co">#&gt; 2:  noise2 0.020582945</span></span>
<span><span class="co">#&gt; 3:      x1 2.278858182</span></span>
<span><span class="co">#&gt; 4:      x2 2.001683415</span></span>
<span><span class="co">#&gt; 5:      x3 1.935324704</span></span></code></pre></div>
<p>Expected: x1 and x2 will show high importance with PFI because
permuting either feature destroys the interaction term x1×x2, which is
crucial for prediction. This demonstrates a key limitation of PFI with
interactions.</p>
</div>
<div class="section level4">
<h4 id="cfi-on-interactions">CFI on Interactions<a class="anchor" aria-label="anchor" href="#cfi-on-interactions"></a>
</h4>
<p>CFI preserves the joint distribution, which should better capture the
interaction effect:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create ARF sampler for the interaction task</span></span>
<span><span class="va">sampler_int</span> <span class="op">=</span> <span class="va"><a href="../reference/ConditionalARFSampler.html">ConditionalARFSampler</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>task <span class="op">=</span> <span class="va">task_int</span>, finite_bounds <span class="op">=</span> <span class="st">"local"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cfi_int</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/CFI.html">CFI</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task_int</span>,</span>
<span>    learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>    measure <span class="op">=</span> <span class="va">measure</span>,</span>
<span>    resampling <span class="op">=</span> <span class="va">resampling</span>,</span>
<span>    n_repeats <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    sampler <span class="op">=</span> <span class="va">sampler_int</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute importance scores</span></span>
<span><span class="va">cfi_int</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">cfi_int</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span>relation <span class="op">=</span> <span class="st">"difference"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;    feature importance</span></span>
<span><span class="co">#&gt;     &lt;char&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:  noise1 0.02435625</span></span>
<span><span class="co">#&gt; 2:  noise2 0.02051248</span></span>
<span><span class="co">#&gt; 3:      x1 2.03202059</span></span>
<span><span class="co">#&gt; 4:      x2 1.69961194</span></span>
<span><span class="co">#&gt; 5:      x3 1.96597388</span></span></code></pre></div>
<p>Expected: CFI should show somewhat lower importance for x1 and x2
compared to PFI because it better preserves the interaction structure
during conditional sampling, providing a more nuanced importance
estimate.</p>
</div>
<div class="section level4">
<h4 id="rfi-on-interactions-targeted-conditional-questions">RFI on Interactions: Targeted Conditional Questions<a class="anchor" aria-label="anchor" href="#rfi-on-interactions-targeted-conditional-questions"></a>
</h4>
<p>RFI’s unique strength is answering specific conditional questions.
Let’s explore what happens when we condition on different features:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># RFI conditioning on x2: "How important is x1 given we know x2?"</span></span>
<span><span class="va">rfi_int_x2</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/RFI.html">RFI</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task_int</span>,</span>
<span>    learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>    measure <span class="op">=</span> <span class="va">measure</span>,</span>
<span>    resampling <span class="op">=</span> <span class="va">resampling</span>,</span>
<span>    conditioning_set <span class="op">=</span> <span class="st">"x2"</span>, <span class="co"># Condition on x2</span></span>
<span>    n_repeats <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    sampler <span class="op">=</span> <span class="va">sampler_int</span></span>
<span><span class="op">)</span></span>
<span><span class="va">rfi_int_x2</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># RFI conditioning on x1: "How important is x2 given we know x1?"</span></span>
<span><span class="va">rfi_int_x1</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/RFI.html">RFI</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task_int</span>,</span>
<span>    learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>    measure <span class="op">=</span> <span class="va">measure</span>,</span>
<span>    resampling <span class="op">=</span> <span class="va">resampling</span>,</span>
<span>    conditioning_set <span class="op">=</span> <span class="st">"x1"</span>, <span class="co"># Condition on x1</span></span>
<span>    n_repeats <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    sampler <span class="op">=</span> <span class="va">sampler_int</span></span>
<span><span class="op">)</span></span>
<span><span class="va">rfi_int_x1</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><strong>RFI Results:</strong></p>
<ul>
<li>
<strong>x1 given x2</strong>: 2.170 (How important is x1 when we
condition on x2)</li>
<li>
<strong>x2 given x1</strong>: 1.579 (How important is x2 when we
condition on x1)<br>
</li>
<li>
<strong>x3 given x2</strong>: 1.979 (How important is x3 when we
condition on x2)</li>
</ul>
<p><strong>Key insight</strong>: In the pure interaction case (y =
2·x1·x2 + x3), when we condition on one interacting feature, the other
becomes extremely important because they only matter together. This
demonstrates RFI’s power to answer targeted questions like “Given I
already know x2, how much does x1 add?”</p>
</div>
<div class="section level4">
<h4 id="comparing-methods-on-interactions">Comparing Methods on Interactions<a class="anchor" aria-label="anchor" href="#comparing-methods-on-interactions"></a>
</h4>
<p>Let’s compare how the methods handle the interaction:</p>
<p><img src="perturbation-importance_files/figure-html/compare-interactions-1.png" class="r-plt" width="768"><img src="perturbation-importance_files/figure-html/compare-interactions-2.png" class="r-plt" width="768"></p>
<p><strong>RFI Conditional Summary</strong>: x1 given x2 has importance
2.170, x2 given x1 has importance 1.579, and x3 given x2 has importance
1.979. This shows how RFI reveals the conditional dependencies that pure
marginal methods miss.</p>
</div>
</div>
<div class="section level3">
<h3 id="key-insights-interaction-effects">Key Insights: Interaction Effects<a class="anchor" aria-label="anchor" href="#key-insights-interaction-effects"></a>
</h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Combine results and calculate ratios</span></span>
<span><span class="va">comp_int</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="va">pfi_int</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span><span class="op">)</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">feature</span>, <span class="va">importance</span>, method <span class="op">=</span> <span class="st">"PFI"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>    <span class="va">cfi_int</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span><span class="op">)</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">feature</span>, <span class="va">importance</span>, method <span class="op">=</span> <span class="st">"CFI"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate the ratio of CFI to PFI importance for interacting features</span></span>
<span><span class="va">int_ratio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/dcast.data.table.html" class="external-link">dcast</a></span><span class="op">(</span><span class="va">comp_int</span><span class="op">[</span><span class="va">feature</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x1"</span>, <span class="st">"x2"</span><span class="op">)</span><span class="op">]</span>, <span class="va">feature</span> <span class="op">~</span> <span class="va">method</span>, value.var <span class="op">=</span> <span class="st">"importance"</span><span class="op">)</span></span>
<span><span class="va">int_ratio</span><span class="op">[</span>, <span class="va">cfi_pfi_ratio</span> <span class="op">:=</span> <span class="va">CFI</span> <span class="op">/</span> <span class="va">PFI</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setattr.html" class="external-link">setnames</a></span><span class="op">(</span><span class="va">int_ratio</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PFI"</span>, <span class="st">"CFI"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pfi_importance"</span>, <span class="st">"cfi_importance"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">int_ratio</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span></span>
<span>        digits <span class="op">=</span> <span class="fl">3</span>,</span>
<span>        caption <span class="op">=</span> <span class="st">"CFI vs PFI for Interacting Features"</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>CFI vs PFI for Interacting Features</caption>
<thead><tr class="header">
<th align="left">feature</th>
<th align="right">cfi_importance</th>
<th align="right">pfi_importance</th>
<th align="right">cfi_pfi_ratio</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">x1</td>
<td align="right">2.032</td>
<td align="right">2.279</td>
<td align="right">0.892</td>
</tr>
<tr class="even">
<td align="left">x2</td>
<td align="right">1.700</td>
<td align="right">2.002</td>
<td align="right">0.849</td>
</tr>
</tbody>
</table>
<p><strong>Important insight about interaction effects</strong>: This
example illustrates a crucial subtlety about PFI and interactions. While
x1 and x2 have no main effects, PFI still correctly identifies them as
important because permuting either feature destroys the interaction term
x1×x2, which is crucial for prediction. The key limitation is that
<strong>PFI cannot distinguish between main effects and interaction
effects</strong> - it measures total contribution including through
interactions.</p>
</div>
</div>
<div class="section level2">
<h2 id="scenario-2-confounding">Scenario 2: Confounding<a class="anchor" aria-label="anchor" href="#scenario-2-confounding"></a>
</h2>
<p>This scenario shows how hidden confounders affect importance
estimates and how conditioning can help:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate confounding scenario</span></span>
<span><span class="va">task_conf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_dgp_scenarios.html">sim_dgp_confounded</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">data_conf</span> <span class="op">&lt;-</span> <span class="va">task_conf</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><strong>Causal Structure:</strong></p>
<div class="grViz html-widget html-fill-item" id="htmlwidget-e5c8c404fe174e4c81bd" style="width:768px;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-e5c8c404fe174e4c81bd">{"x":{"diagram":"\ndigraph confounding_dag {\n  rankdir=TB;\n  node [shape=circle, style=filled, fontname=\"Arial\", fontsize=12];\n\n  # Hidden confounder\n  H [fillcolor=\"red\", label=\"Hidden\\nConfounder\", fontcolor=\"white\"];\n\n  # Observed features\n  x1 [fillcolor=\"lightblue\", label=\"x1\"];\n  proxy [fillcolor=\"orange\", label=\"proxy\"];\n  independent [fillcolor=\"lightblue\", label=\"independent\"];\n\n  # Outcome\n  y [fillcolor=\"greenyellow\", label=\"y\"];\n\n  # Confounding paths (creating spurious correlations)\n  H -> x1 [label=\"1.0\", color=\"red\"];\n  H -> proxy [label=\"1.0\", color=\"red\"];\n  H -> y [label=\"1.0\", color=\"red\", penwidth=2];\n\n  # Direct causal effects\n  x1 -> y [label=\"1.0\", color=\"blue\"];\n  independent -> y [label=\"1.0\", color=\"blue\"];\n\n  # Layout\n  {rank=same; x1, proxy, independent}\n}\n","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script><p>The <strong>red arrows</strong> show the confounding paths: the
hidden confounder creates spurious correlations between x1, proxy, and
y. The <strong>blue arrows</strong> show true direct causal effects.
Note that <code>independent</code> is truly independent (no confounding)
while <code>proxy</code> provides a noisy measurement of the
confounder.</p>
<p>In the <strong>observable confounder scenario</strong> (used later),
the confounder H would be included as a feature in the dataset, allowing
direct conditioning rather than relying on the noisy proxy.</p>
<p><img src="perturbation-importance_files/figure-html/viz-confounding-1.png" class="r-plt" width="768"></p>
<p><strong>Key insight</strong>: The hidden confounder creates spurious
correlations between x1 and y (red paths), making x1 appear more
important than its true direct effect. RFI conditioning on the proxy
(which measures the confounder) should help isolate the true direct
effect (blue path).</p>
<div class="section level3">
<h3 id="analysis-1">Analysis<a class="anchor" aria-label="anchor" href="#analysis-1"></a>
</h3>
<p>Now let’s analyze the confounding scenario where a hidden confounder
affects both features and the outcome.</p>
<div class="section level4">
<h4 id="pfi-on-confounded-data">PFI on Confounded Data<a class="anchor" aria-label="anchor" href="#pfi-on-confounded-data"></a>
</h4>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pfi_conf</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/PFI.html">PFI</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task_conf</span>,</span>
<span>    learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>    measure <span class="op">=</span> <span class="va">measure</span>,</span>
<span>    resampling <span class="op">=</span> <span class="va">resampling</span>,</span>
<span>    n_repeats <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">pfi_conf</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">pfi_conf</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;        feature importance</span></span>
<span><span class="co">#&gt;         &lt;char&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: independent   1.571777</span></span>
<span><span class="co">#&gt; 2:       proxy   1.289117</span></span>
<span><span class="co">#&gt; 3:          x1   3.586063</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="rfi-conditioning-on-proxy">RFI Conditioning on Proxy<a class="anchor" aria-label="anchor" href="#rfi-conditioning-on-proxy"></a>
</h4>
<p>RFI can condition on the proxy to help isolate direct effects:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create sampler for confounding task</span></span>
<span><span class="va">sampler_conf</span> <span class="op">=</span> <span class="va"><a href="../reference/ConditionalARFSampler.html">ConditionalARFSampler</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task_conf</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    finite_bounds <span class="op">=</span> <span class="st">"local"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># RFI conditioning on the proxy</span></span>
<span><span class="va">rfi_conf</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/RFI.html">RFI</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task_conf</span>,</span>
<span>    learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>    measure <span class="op">=</span> <span class="va">measure</span>,</span>
<span>    resampling <span class="op">=</span> <span class="va">resampling</span>,</span>
<span>    conditioning_set <span class="op">=</span> <span class="st">"proxy"</span>, <span class="co"># Condition on proxy to reduce confounding</span></span>
<span>    n_repeats <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    sampler <span class="op">=</span> <span class="va">sampler_conf</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">rfi_conf</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">rfi_conf</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;        feature importance</span></span>
<span><span class="co">#&gt;         &lt;char&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: independent   1.622194</span></span>
<span><span class="co">#&gt; 2:       proxy   0.000000</span></span>
<span><span class="co">#&gt; 3:          x1   1.749965</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="also-trying-cfi-for-comparison">Also trying CFI for comparison<a class="anchor" aria-label="anchor" href="#also-trying-cfi-for-comparison"></a>
</h4>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cfi_conf</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/CFI.html">CFI</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task_conf</span>,</span>
<span>    learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>    measure <span class="op">=</span> <span class="va">measure</span>,</span>
<span>    resampling <span class="op">=</span> <span class="va">resampling</span>,</span>
<span>    n_repeats <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    sampler <span class="op">=</span> <span class="va">sampler_conf</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: <span style="color: #BBBB00;">!</span> Provided sampler has a pre-configured `conditioning_set`.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> To calculate <span style="color: #0000BB;">&lt;CFI&gt;</span> correctly, `conditioning_set` will be reset such that</span></span>
<span><span class="co">#&gt;   sampling is performed conditionally on all remaining features.</span></span>
<span></span>
<span><span class="va">cfi_conf</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">cfi_conf</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;        feature importance</span></span>
<span><span class="co">#&gt;         &lt;char&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: independent  1.5586791</span></span>
<span><span class="co">#&gt; 2:       proxy  0.2084425</span></span>
<span><span class="co">#&gt; 3:          x1  1.6674019</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="observable-confounder-scenario">Observable Confounder Scenario<a class="anchor" aria-label="anchor" href="#observable-confounder-scenario"></a>
</h4>
<p>In many real-world situations, confounders are actually observable
(e.g., demographics, baseline characteristics). Let’s explore how RFI
performs when we can condition directly on the true confounder:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate scenario where confounder is observable</span></span>
<span><span class="va">task_conf_obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_dgp_scenarios.html">sim_dgp_confounded</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1000</span>, hidden <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Now we can condition directly on the true confounder</span></span>
<span><span class="va">sampler_conf_obs</span> <span class="op">=</span> <span class="va"><a href="../reference/ConditionalARFSampler.html">ConditionalARFSampler</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task_conf_obs</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    finite_bounds <span class="op">=</span> <span class="st">"local"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># RFI conditioning on the true confounder (not just proxy)</span></span>
<span><span class="va">rfi_conf_obs</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/RFI.html">RFI</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task_conf_obs</span>,</span>
<span>    learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>    measure <span class="op">=</span> <span class="va">measure</span>,</span>
<span>    resampling <span class="op">=</span> <span class="va">resampling</span>,</span>
<span>    conditioning_set <span class="op">=</span> <span class="st">"confounder"</span>, <span class="co"># Condition on true confounder</span></span>
<span>    n_repeats <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    sampler <span class="op">=</span> <span class="va">sampler_conf_obs</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">rfi_conf_obs</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">rfi_conf_obs</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;        feature   importance</span></span>
<span><span class="co">#&gt;         &lt;char&gt;        &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:  confounder  0.000000000</span></span>
<span><span class="co">#&gt; 2: independent  1.539426725</span></span>
<span><span class="co">#&gt; 3:       proxy -0.002651167</span></span>
<span><span class="co">#&gt; 4:          x1  0.549141497</span></span>
<span></span>
<span><span class="co"># Compare with PFI on the same data</span></span>
<span><span class="va">pfi_conf_obs</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/PFI.html">PFI</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task_conf_obs</span>,</span>
<span>    learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>    measure <span class="op">=</span> <span class="va">measure</span>,</span>
<span>    resampling <span class="op">=</span> <span class="va">resampling</span>,</span>
<span>    n_repeats <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="op">)</span></span>
<span><span class="va">pfi_conf_obs</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">pfi_conf_obs</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;        feature importance</span></span>
<span><span class="co">#&gt;         &lt;char&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:  confounder 1.62325668</span></span>
<span><span class="co">#&gt; 2: independent 1.62540310</span></span>
<span><span class="co">#&gt; 3:       proxy 0.05759922</span></span>
<span><span class="co">#&gt; 4:          x1 2.18558022</span></span></code></pre></div>
<p><strong>Key Results:</strong></p>
<ul>
<li>
<strong>x1 importance</strong>: PFI = 2.186, RFI|confounder =
0.549</li>
<li>
<strong>independent importance</strong>: PFI = 1.625, RFI|confounder
= 1.539</li>
</ul>
<p><strong>Insight</strong>: When conditioning on the true confounder,
RFI should show reduced importance for x1 (since much of its apparent
importance was due to confounding) while independent maintains its
importance (since it’s truly causally related to y).</p>
</div>
<div class="section level4">
<h4 id="comparing-methods-on-confounding">Comparing Methods on Confounding<a class="anchor" aria-label="anchor" href="#comparing-methods-on-confounding"></a>
</h4>
<p><img src="perturbation-importance_files/figure-html/compare-confounding-1.png" class="r-plt" width="768"><img src="perturbation-importance_files/figure-html/compare-confounding-2.png" class="r-plt" width="768"></p>
</div>
</div>
<div class="section level3">
<h3 id="key-insights-confounding-effects">Key Insights: Confounding Effects<a class="anchor" aria-label="anchor" href="#key-insights-confounding-effects"></a>
</h3>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Show how conditioning affects importance estimates</span></span>
<span><span class="va">conf_wide</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/dcast.data.table.html" class="external-link">dcast</a></span><span class="op">(</span><span class="va">comp_conf_long</span>, <span class="va">feature</span> <span class="op">~</span> <span class="va">method</span>, value.var <span class="op">=</span> <span class="st">"importance"</span><span class="op">)</span></span>
<span><span class="va">conf_summary</span> <span class="op">&lt;-</span> <span class="va">conf_wide</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>    <span class="va">feature</span>,</span>
<span>    pfi_importance <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">PFI</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>    cfi_importance <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">CFI</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>    rfi_proxy_importance <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">RFI</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>    pfi_rfi_diff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">PFI</span> <span class="op">-</span> <span class="va">RFI</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">conf_summary</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span></span>
<span>        caption <span class="op">=</span> <span class="st">"Effect of Conditioning on Proxy in Confounded Scenario"</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Effect of Conditioning on Proxy in Confounded
Scenario</caption>
<colgroup>
<col width="15%">
<col width="19%">
<col width="19%">
<col width="27%">
<col width="17%">
</colgroup>
<thead><tr class="header">
<th align="left">feature</th>
<th align="right">pfi_importance</th>
<th align="right">cfi_importance</th>
<th align="right">rfi_proxy_importance</th>
<th align="right">pfi_rfi_diff</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">independent</td>
<td align="right">1.572</td>
<td align="right">1.559</td>
<td align="right">1.622</td>
<td align="right">-0.050</td>
</tr>
<tr class="even">
<td align="left">proxy</td>
<td align="right">1.289</td>
<td align="right">0.208</td>
<td align="right">0.000</td>
<td align="right">1.289</td>
</tr>
<tr class="odd">
<td align="left">x1</td>
<td align="right">3.586</td>
<td align="right">1.667</td>
<td align="right">1.750</td>
<td align="right">1.836</td>
</tr>
</tbody>
</table>
<p>In the confounding scenario, we observed:</p>
<ol style="list-style-type: decimal">
<li><p><strong>PFI shows confounded effects</strong>: Without accounting
for confounders, PFI overestimates the importance of x1 due to its
spurious correlation with y through the hidden confounder.</p></li>
<li><p><strong>RFI conditioning on proxy reduces bias</strong>: By
conditioning on the proxy (noisy measurement of the confounder), RFI can
partially isolate direct effects, though some confounding remains due to
measurement error.</p></li>
<li><p><strong>RFI conditioning on true confounder removes
bias</strong>: When the confounder is observable and we can condition
directly on it, RFI dramatically reduces the apparent importance of x1,
revealing its true direct effect.</p></li>
<li><p><strong>CFI partially accounts for confounding</strong>: Through
its conditional sampling, CFI captures some of the confounding structure
but cannot target specific confounders like RFI can.</p></li>
</ol>
</div>
</div>
<div class="section level2">
<h2 id="scenario-3-correlated-features">Scenario 3: Correlated Features<a class="anchor" aria-label="anchor" href="#scenario-3-correlated-features"></a>
</h2>
<p>This scenario demonstrates the fundamental difference between
marginal and conditional methods when features are highly
correlated:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate correlated features scenario</span></span>
<span><span class="va">task_cor</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_dgp_scenarios.html">sim_dgp_correlated</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">data_cor</span> <span class="op">&lt;-</span> <span class="va">task_cor</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><strong>Causal Structure:</strong></p>
<div class="grViz html-widget html-fill-item" id="htmlwidget-36aa3d2a04d42bbc2145" style="width:576px;height:384px;"></div>
<script type="application/json" data-for="htmlwidget-36aa3d2a04d42bbc2145">{"x":{"diagram":"\ndigraph correlated_dag {\n  rankdir=TB;\n  node [shape=circle, style=filled, fontname=\"Arial\", fontsize=12];\n  \n  # Feature nodes\n  x1 [fillcolor=\"lightblue\", label=\"x1\"];\n  x2 [fillcolor=\"lightblue\", label=\"x2\"];\n  x3 [fillcolor=\"lightblue\", label=\"x3\"];\n  x4 [fillcolor=\"lightgray\", label=\"x4\"];\n  \n  # Outcome\n  y [fillcolor=\"greenyellow\", label=\"y\"];\n  \n  # Direct effects\n  x1 -> y [label=\"2.0\", color=\"blue\"];\n  x3 -> y [label=\"1.0\", color=\"blue\"];\n  # x2 has NO direct effect on y despite high correlation with x1\n  \n  # Correlation between x1 and x2 (bidirectional dashed line)\n  x1 -> x2 [dir=both, style=dashed, color=\"purple\", label=\"r=0.9\"];\n  \n  # Layout\n  {rank=same; x1, x2, x3, x4}\n}\n","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script><p><strong>Key feature</strong>: x1 and x2 are highly correlated (r =
0.9 from MVN) but only x1 has a causal effect on y. x2 is a spurious
predictor - correlated with the causal feature but not causal
itself.</p>
<div class="section level3">
<h3 id="analysis-2">Analysis<a class="anchor" aria-label="anchor" href="#analysis-2"></a>
</h3>
<p>Let’s analyze how different methods handle highly correlated
features:</p>
<div class="section level4">
<h4 id="pfi-on-correlated-features">PFI on Correlated Features<a class="anchor" aria-label="anchor" href="#pfi-on-correlated-features"></a>
</h4>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pfi_cor</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/PFI.html">PFI</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task_cor</span>,</span>
<span>    learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>    measure <span class="op">=</span> <span class="va">measure</span>,</span>
<span>    resampling <span class="op">=</span> <span class="va">resampling</span>,</span>
<span>    n_repeats <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">pfi_cor</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">pfi_cor</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;    feature   importance</span></span>
<span><span class="co">#&gt;     &lt;char&gt;        &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      x1  5.156513945</span></span>
<span><span class="co">#&gt; 2:      x2  0.521717907</span></span>
<span><span class="co">#&gt; 3:      x3  1.683942121</span></span>
<span><span class="co">#&gt; 4:      x4 -0.001536471</span></span></code></pre></div>
<p>Expected: PFI will show high importance for BOTH x1 and x2, even
though only x1 has a true causal effect. This happens because x2 is
highly correlated with x1, so permuting x2 destroys predictive
information about x1.</p>
</div>
<div class="section level4">
<h4 id="cfi-on-correlated-features">CFI on Correlated Features<a class="anchor" aria-label="anchor" href="#cfi-on-correlated-features"></a>
</h4>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create ARF sampler for correlated task</span></span>
<span><span class="va">sampler_cor</span> <span class="op">=</span> <span class="va"><a href="../reference/ConditionalARFSampler.html">ConditionalARFSampler</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>task <span class="op">=</span> <span class="va">task_cor</span>, finite_bounds <span class="op">=</span> <span class="st">"local"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cfi_cor</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/CFI.html">CFI</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task_cor</span>,</span>
<span>    learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>    measure <span class="op">=</span> <span class="va">measure</span>,</span>
<span>    resampling <span class="op">=</span> <span class="va">resampling</span>,</span>
<span>    n_repeats <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    sampler <span class="op">=</span> <span class="va">sampler_cor</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">cfi_cor</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">cfi_cor</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;    feature   importance</span></span>
<span><span class="co">#&gt;     &lt;char&gt;        &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      x1  2.040455912</span></span>
<span><span class="co">#&gt; 2:      x2  0.101151870</span></span>
<span><span class="co">#&gt; 3:      x3  1.638895975</span></span>
<span><span class="co">#&gt; 4:      x4 -0.001503762</span></span></code></pre></div>
<p>Expected: CFI should show high importance for x1 (the true causal
feature) but near-zero importance for x2 (the spurious correlated
feature) because conditional sampling preserves the correlation
structure and can distinguish between causal and spurious
predictors.</p>
</div>
<div class="section level4">
<h4 id="rfi-to-answer-conditional-questions">RFI to Answer Conditional Questions<a class="anchor" aria-label="anchor" href="#rfi-to-answer-conditional-questions"></a>
</h4>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># RFI conditioning on x1: "How important is x2 given we know x1?"</span></span>
<span><span class="va">rfi_cor_x1</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/RFI.html">RFI</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task_cor</span>,</span>
<span>    learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>    measure <span class="op">=</span> <span class="va">measure</span>,</span>
<span>    resampling <span class="op">=</span> <span class="va">resampling</span>,</span>
<span>    conditioning_set <span class="op">=</span> <span class="st">"x1"</span>,</span>
<span>    n_repeats <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    sampler <span class="op">=</span> <span class="va">sampler_cor</span></span>
<span><span class="op">)</span></span>
<span><span class="va">rfi_cor_x1</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># RFI conditioning on x2: "How important is x1 given we know x2?"</span></span>
<span><span class="va">rfi_cor_x2</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/RFI.html">RFI</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task_cor</span>,</span>
<span>    learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>    measure <span class="op">=</span> <span class="va">measure</span>,</span>
<span>    resampling <span class="op">=</span> <span class="va">resampling</span>,</span>
<span>    conditioning_set <span class="op">=</span> <span class="st">"x2"</span>,</span>
<span>    n_repeats <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    sampler <span class="op">=</span> <span class="va">sampler_cor</span></span>
<span><span class="op">)</span></span>
<span><span class="va">rfi_cor_x2</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><strong>RFI Results:</strong> - <strong>x2 given x1</strong>: 0.083
(How much does x2 add when we already know x1?) - <strong>x1 given
x2</strong>: 1.962 (How much does x1 add when we already know x2?)</p>
<p>Expected: When conditioning on x1, the importance of x2 should be
near zero (and vice versa) because they’re almost identical - knowing
one tells you almost everything about the other.</p>
</div>
<div class="section level4">
<h4 id="comparing-methods-on-correlated-features">Comparing Methods on Correlated Features<a class="anchor" aria-label="anchor" href="#comparing-methods-on-correlated-features"></a>
</h4>
<p><img src="perturbation-importance_files/figure-html/compare-correlated-1.png" class="r-plt" width="768"></p>
</div>
</div>
<div class="section level3">
<h3 id="key-insights-correlated-features">Key Insights: Correlated Features<a class="anchor" aria-label="anchor" href="#key-insights-correlated-features"></a>
</h3>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cor_ratio</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span></span>
<span>        digits <span class="op">=</span> <span class="fl">3</span>,</span>
<span>        caption <span class="op">=</span> <span class="st">"CFI vs PFI for Highly Correlated Features"</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>CFI vs PFI for Highly Correlated Features</caption>
<thead><tr class="header">
<th align="left">feature</th>
<th align="right">CFI</th>
<th align="right">PFI</th>
<th align="right">cfi_pfi_ratio</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">x1</td>
<td align="right">2.040</td>
<td align="right">5.157</td>
<td align="right">0.396</td>
</tr>
<tr class="even">
<td align="left">x2</td>
<td align="right">0.101</td>
<td align="right">0.522</td>
<td align="right">0.194</td>
</tr>
</tbody>
</table>
<p>In the correlated features scenario:</p>
<ol style="list-style-type: decimal">
<li><p><strong>PFI overestimates importance of spurious
features</strong>: PFI assigns high importance to BOTH x1 (causal) and
x2 (spurious) because they’re highly correlated. Permuting x2 destroys
information about x1, making x2 appear important even though it has no
causal effect.</p></li>
<li><p><strong>CFI correctly identifies causal features</strong>: By
preserving the correlation structure during conditional sampling, CFI
can distinguish between x1 (truly causal) and x2 (merely correlated),
assigning high importance only to x1.</p></li>
<li><p><strong>RFI reveals redundancy</strong>: When conditioning on x1,
the additional importance of x2 is near zero (and vice versa), correctly
identifying their redundancy for prediction.</p></li>
<li><p><strong>Practical implication</strong>: PFI would mislead you to
think both features are important. CFI correctly shows that only x1 is
truly important, while x2 is just along for the ride due to
correlation.</p></li>
</ol>
</div>
</div>
<div class="section level2">
<h2 id="scenario-4-independent-features-baseline">Scenario 4: Independent Features (Baseline)<a class="anchor" aria-label="anchor" href="#scenario-4-independent-features-baseline"></a>
</h2>
<p>To provide a baseline comparison, let’s examine a scenario where all
feature importance methods should produce similar results:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate independent features scenario</span></span>
<span><span class="va">task_ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_dgp_scenarios.html">sim_dgp_independent</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">data_ind</span> <span class="op">&lt;-</span> <span class="va">task_ind</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><strong>Causal Structure:</strong></p>
<div class="grViz html-widget html-fill-item" id="htmlwidget-febe03efa1a2d8d52a86" style="width:576px;height:384px;"></div>
<script type="application/json" data-for="htmlwidget-febe03efa1a2d8d52a86">{"x":{"diagram":"\ndigraph independent_dag {\n  rankdir=TB;\n  node [shape=circle, style=filled, fontname=\"Arial\", fontsize=12];\n  \n  # Feature nodes\n  important1 [fillcolor=\"lightblue\", label=\"important1\"];\n  important2 [fillcolor=\"lightblue\", label=\"important2\"];\n  important3 [fillcolor=\"lightblue\", label=\"important3\"];\n  unimportant1 [fillcolor=\"lightgray\", label=\"unimportant1\"];\n  unimportant2 [fillcolor=\"lightgray\", label=\"unimportant2\"];\n  \n  # Outcome\n  y [fillcolor=\"greenyellow\", label=\"y\"];\n  \n  # Direct effects only - no interactions or confounding\n  important1 -> y [label=\"2.0\", color=\"blue\"];\n  important2 -> y [label=\"1.0\", color=\"blue\"];\n  important3 -> y [label=\"0.5\", color=\"blue\"];\n  \n  # No edge from unimportant features to y\n  \n  # Layout\n  {rank=same; important1, important2, important3, unimportant1, unimportant2}\n}\n","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script><p>This is the <strong>simplest scenario</strong>: all features are
independent, there are no interactions, and no confounding. Each feature
has only a direct effect on y (or no effect in the case of noise).</p>
<div class="section level3">
<h3 id="running-all-methods-on-independent-features">Running All Methods on Independent Features<a class="anchor" aria-label="anchor" href="#running-all-methods-on-independent-features"></a>
</h3>
<p>First PFI:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># PFI</span></span>
<span><span class="va">pfi_ind</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/PFI.html">PFI</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task_ind</span>,</span>
<span>    learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>    measure <span class="op">=</span> <span class="va">measure</span>,</span>
<span>    resampling <span class="op">=</span> <span class="va">resampling</span>,</span>
<span>    n_repeats <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="op">)</span></span>
<span><span class="va">pfi_ind</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Now CFI with the ARF sampler:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sampler_ind</span> <span class="op">=</span> <span class="va"><a href="../reference/ConditionalARFSampler.html">ConditionalARFSampler</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>task <span class="op">=</span> <span class="va">task_ind</span>, finite_bounds <span class="op">=</span> <span class="st">"local"</span><span class="op">)</span></span>
<span><span class="va">cfi_ind</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/CFI.html">CFI</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task_ind</span>,</span>
<span>    learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>    measure <span class="op">=</span> <span class="va">measure</span>,</span>
<span>    resampling <span class="op">=</span> <span class="va">resampling</span>,</span>
<span>    n_repeats <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    sampler <span class="op">=</span> <span class="va">sampler_ind</span></span>
<span><span class="op">)</span></span>
<span><span class="va">cfi_ind</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>RFI with empty conditioning set, basically equivalent to PFI with a
different sampler:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rfi_ind</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/RFI.html">RFI</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task_ind</span>,</span>
<span>    learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>    measure <span class="op">=</span> <span class="va">measure</span>,</span>
<span>    resampling <span class="op">=</span> <span class="va">resampling</span>,</span>
<span>    conditioning_set <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>, <span class="co"># Empty set</span></span>
<span>    n_repeats <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    sampler <span class="op">=</span> <span class="va">sampler_ind</span></span>
<span><span class="op">)</span></span>
<span><span class="va">rfi_ind</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>And now we visualize:</p>
<p><img src="perturbation-importance_files/figure-html/combine-rf-plot-1.png" class="r-plt" width="768"></p>
</div>
<div class="section level3">
<h3 id="agreement-between-methods">Agreement Between Methods<a class="anchor" aria-label="anchor" href="#agreement-between-methods"></a>
</h3>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate coefficient of variation for each feature across methods</span></span>
<span><span class="va">comp_ind_wide</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/dcast.data.table.html" class="external-link">dcast</a></span><span class="op">(</span><span class="va">comp_ind_long</span>, <span class="va">feature</span> <span class="op">~</span> <span class="va">method</span>, value.var <span class="op">=</span> <span class="st">"importance"</span><span class="op">)</span></span>
<span><span class="va">comp_ind_wide</span><span class="op">[</span>,</span>
<span>    <span class="fu">`:=`</span><span class="op">(</span></span>
<span>        mean_importance <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">.SD</span><span class="op">)</span>,</span>
<span>        sd_importance <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="fl">1</span>, <span class="va">sd</span><span class="op">)</span>,</span>
<span>        cv <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="fl">1</span>, <span class="va">sd</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">.SD</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    .SDcols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PFI"</span>, <span class="st">"CFI"</span>, <span class="st">"RFI"</span><span class="op">)</span></span>
<span><span class="op">]</span></span>
<span></span>
<span><span class="va">comp_ind_wide</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>    <span class="va">feature</span>,</span>
<span>    mean_importance <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">mean_importance</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>    cv <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">cv</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>    agreement <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">cv</span> <span class="op">&lt;</span> <span class="fl">0.1</span>, <span class="st">"High"</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">cv</span> <span class="op">&lt;</span> <span class="fl">0.2</span>, <span class="st">"Moderate"</span>, <span class="st">"Low"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span></span>
<span>        caption <span class="op">=</span> <span class="st">"Method Agreement on Independent Features"</span>,</span>
<span>        col.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Feature"</span>, <span class="st">"Mean Importance"</span>, <span class="st">"Coef. of Variation"</span>, <span class="st">"Agreement Level"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Method Agreement on Independent Features</caption>
<thead><tr class="header">
<th align="left">Feature</th>
<th align="right">Mean Importance</th>
<th align="right">Coef. of Variation</th>
<th align="left">Agreement Level</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">important1</td>
<td align="right">6.362</td>
<td align="right">0.055</td>
<td align="left">High</td>
</tr>
<tr class="even">
<td align="left">important2</td>
<td align="right">1.759</td>
<td align="right">0.288</td>
<td align="left">Low</td>
</tr>
<tr class="odd">
<td align="left">important3</td>
<td align="right">0.292</td>
<td align="right">0.073</td>
<td align="left">High</td>
</tr>
<tr class="even">
<td align="left">unimportant1</td>
<td align="right">-0.003</td>
<td align="right">-1.190</td>
<td align="left">High</td>
</tr>
<tr class="odd">
<td align="left">unimportant2</td>
<td align="right">-0.003</td>
<td align="right">-0.301</td>
<td align="left">High</td>
</tr>
</tbody>
</table>
<p><strong>Key insight</strong>: With independent features and no
complex relationships, all three methods (PFI, CFI, RFI) produce very
similar importance estimates. This confirms that the differences we
observe in Scenarios 1 and 2 are truly due to interactions and
confounding, not artifacts of the methods themselves.</p>
</div>
<div class="section level3">
<h3 id="key-insights-independent-features">Key Insights: Independent Features<a class="anchor" aria-label="anchor" href="#key-insights-independent-features"></a>
</h3>
<p>In the baseline scenario with independent features:</p>
<ol style="list-style-type: decimal">
<li><p><strong>All methods agree</strong>: PFI, CFI, and RFI produce
nearly identical importance estimates when features are truly
independent.</p></li>
<li><p><strong>Validates methodology</strong>: The agreement between
methods confirms that differences in other scenarios are due to data
structure, not method artifacts.</p></li>
<li><p><strong>Noise correctly identified</strong>: All methods
correctly assign near-zero importance to the noise features.</p></li>
</ol>
</div>
</div>
<div class="section level2">
<h2 id="variance-estimation-and-confidence-intervals">Variance Estimation and Confidence Intervals<a class="anchor" aria-label="anchor" href="#variance-estimation-and-confidence-intervals"></a>
</h2>
<p>When using resampling, xplainfi can compute confidence intervals for
importance scores to quantify uncertainty. However, standard variance
calculations produce confidence intervals that are too narrow when
observations appear in multiple resampling folds.</p>
<div class="section level3">
<h3 id="example-corrected-vs-uncorrected-confidence-intervals">Example: Corrected vs Uncorrected Confidence Intervals<a class="anchor" aria-label="anchor" href="#example-corrected-vs-uncorrected-confidence-intervals"></a>
</h3>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Demonstrate variance correction with subsampling</span></span>
<span><span class="va">task_var</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_dgp_scenarios.html">sim_dgp_independent</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">300</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pfi_var</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/PFI.html">PFI</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task_var</span>,</span>
<span>    learner <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">lrn</a></span><span class="op">(</span><span class="st">"regr.ranger"</span>, num.trees <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,</span>
<span>    measure <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">msr</a></span><span class="op">(</span><span class="st">"regr.mse"</span><span class="op">)</span>,</span>
<span>    resampling <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">rsmp</a></span><span class="op">(</span><span class="st">"subsampling"</span>, repeats <span class="op">=</span> <span class="fl">10</span>, ratio <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span>,</span>
<span>    n_repeats <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">pfi_var</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare variance methods</span></span>
<span><span class="va">imp_raw</span> <span class="op">&lt;-</span> <span class="va">pfi_var</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span>ci_method <span class="op">=</span> <span class="st">"raw"</span><span class="op">)</span> <span class="co"># Uncorrected (too narrow!)</span></span>
<span><span class="va">imp_corrected</span> <span class="op">&lt;-</span> <span class="va">pfi_var</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span>ci_method <span class="op">=</span> <span class="st">"nadeau_bengio"</span><span class="op">)</span> <span class="co"># Corrected</span></span>
<span></span>
<span><span class="co"># Show the difference for important features</span></span>
<span><span class="va">imp_raw</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"^important"</span>, <span class="va">feature</span><span class="op">)</span>, <span class="fu">.</span><span class="op">(</span><span class="va">feature</span>, <span class="va">importance</span>, <span class="va">conf_lower</span>, <span class="va">conf_upper</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;       feature importance conf_lower conf_upper</span></span>
<span><span class="co">#&gt;        &lt;char&gt;      &lt;num&gt;      &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: important1  7.5285208  6.7936479  8.2633937</span></span>
<span><span class="co">#&gt; 2: important2  1.4363782  1.3240233  1.5487331</span></span>
<span><span class="co">#&gt; 3: important3  0.1954965  0.1533125  0.2376805</span></span>
<span><span class="va">imp_corrected</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"^important"</span>, <span class="va">feature</span><span class="op">)</span>, <span class="fu">.</span><span class="op">(</span><span class="va">feature</span>, <span class="va">importance</span>, <span class="va">conf_lower</span>, <span class="va">conf_upper</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;       feature importance conf_lower conf_upper</span></span>
<span><span class="co">#&gt;        &lt;char&gt;      &lt;num&gt;      &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: important1  7.5285208  6.1536995  8.9033422</span></span>
<span><span class="co">#&gt; 2: important2  1.4363782  1.2261814  1.6465750</span></span>
<span><span class="co">#&gt; 3: important3  0.1954965  0.1165775  0.2744156</span></span></code></pre></div>
<p><img src="perturbation-importance_files/figure-html/variance-comparison-plot-1.png" class="r-plt" width="768"></p>
</div>
<div class="section level3">
<h3 id="practical-recommendations">Practical Recommendations<a class="anchor" aria-label="anchor" href="#practical-recommendations"></a>
</h3>
<ul>
<li>Use <code>ci_method = "nadeau_bengio"</code> when using bootstrap or
subsampling for improved (yet still flawed) confidence intervals</li>
<li>The default <code>ci_method = "none"</code> returns only point
estimates without uncertainty</li>
<li>Never use <code>ci_method = "raw"</code> for actual results, the
uncorrected intervals are misleadingly narrow</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="key-takeaways">Key Takeaways<a class="anchor" aria-label="anchor" href="#key-takeaways"></a>
</h2>
<p>Through these four scenarios, we’ve demonstrated:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Method choice matters</strong>:
<ul>
<li>
<strong>PFI</strong> is simple and fast but can miss interaction
effects, underestimate importance of correlated features, and be
affected by confounding</li>
<li>
<strong>CFI</strong> captures feature dependencies and interactions
through conditional sampling, correctly handling correlated
features</li>
<li>
<strong>RFI</strong> allows targeted conditioning to isolate
specific relationships and reveal redundancy</li>
</ul>
</li>
<li>
<strong>When to use each method</strong>:
<ul>
<li>Use <strong>PFI</strong> when features are believed to be
independent (as in Scenario 4) and you want a quick baseline importance
ranking</li>
<li>Use <strong>CFI</strong> when you suspect feature interactions,
correlations, or dependencies (as in Scenarios 1 &amp; 3) and want a
sophisticated analysis that respects feature relationships</li>
<li>Use <strong>RFI</strong> when you have specific conditional
questions: “How important is feature X given I already know feature Y?”
(as in Scenarios 1, 2 &amp; 3). Essential for feature selection and
understanding incremental value.</li>
</ul>
</li>
<li>
<strong>Practical considerations</strong>:
<ul>
<li>All methods benefit from cross-validation and multiple permutation
iterations for stability</li>
<li>ARF-based conditional sampling (used in CFI/RFI) is more
computationally intensive than marginal sampling</li>
<li>The choice of conditioning set in RFI requires domain knowledge</li>
</ul>
</li>
</ol>
</div>
<div class="section level2">
<h2 id="further-reading">Further Reading<a class="anchor" aria-label="anchor" href="#further-reading"></a>
</h2>
<p>For more details on these methods and their theoretical foundations,
see:</p>
<ul>
<li>Breiman (2001) for the original PFI formulation</li>
<li>Strobl et al. (2008) for limitations of PFI with correlated
features<br>
</li>
<li>Watson &amp; Wright (2021) for conditional sampling with ARF</li>
<li>König et al. (2021) for relative feature importance</li>
<li>Ewald et al. (2024) for a comprehensive review of feature importance
methods</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://lukasburk.de" class="external-link">Lukas Burk</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
