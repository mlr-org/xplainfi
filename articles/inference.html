<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Inference for Feature Importance • xplainfi</title>
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Roboto-0.4.10/font.css" rel="stylesheet">
<link href="../deps/JetBrains_Mono-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Roboto_Slab-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Inference for Feature Importance">
<script defer src="https://umami.jemu.name/script.js" data-website-id="248c8668-4908-4c63-86f7-db0a1b19758a"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">xplainfi</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/xplainfi.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><h6 class="dropdown-header" data-toc-skip>Method Showcase</h6></li>
    <li><a class="dropdown-item" href="../articles/perturbation-importance.html">Perturbation-Based Methods (PFI, CFI, RFI)</a></li>
    <li><a class="dropdown-item" href="../articles/loco.html">Model Refitting Measures (LOCO, WVIM)</a></li>
    <li><a class="dropdown-item" href="../articles/sage-methods.html">Shapley Additive Global ImportancE (SAGE)</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Specialized Topics</h6></li>
    <li><a class="dropdown-item" href="../articles/feature-samplers.html">Feature Samplers</a></li>
    <li><a class="dropdown-item" href="../articles/inference.html">Inference for Feature Importances</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Testing &amp; Validation</h6></li>
    <li><a class="dropdown-item" href="../articles/simulation-settings.html">Simulation Settings</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mlr-org/xplainfi/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<link href="inference_files/htmltools-fill-0.5.9/fill.css" rel="stylesheet">
<script src="inference_files/htmlwidgets-1.6.4/htmlwidgets.js"></script><script src="inference_files/viz-1.8.2/viz.js"></script><link href="inference_files/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="inference_files/grViz-binding-1.0.11/grViz.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Inference for Feature Importance</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mlr-org/xplainfi/blob/main/vignettes/articles/inference.Rmd" class="external-link"><code>vignettes/articles/inference.Rmd</code></a></small>
      <div class="d-none name"><code>inference.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr-org.github.io/xplainfi/">xplainfi</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3learners.mlr-org.com" class="external-link">mlr3learners</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: mlr3</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<p>There are multiple (work in progress) inference methods available
with the underlying implementation, but the API around them is still
being worked out.</p>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>We use a simple linear DGP for demonstration purposes where</p>
<ul>
<li>
<span class="math inline">\(X_1\)</span> and <span class="math inline">\(X_2\)</span> are strongly correlated (r =
0.7)</li>
<li>
<span class="math inline">\(X_1\)</span> and <span class="math inline">\(X_3\)</span> have an effect on Y</li>
<li>
<span class="math inline">\(X_2\)</span> and <span class="math inline">\(X_4\)</span> don’t have an effect</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="../reference/sim_dgp_scenarios.html">sim_dgp_correlated</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">2000</span>, r <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="va">learner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">lrn</a></span><span class="op">(</span><span class="st">"regr.ranger"</span>, num.trees <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span><span class="va">measure</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">msr</a></span><span class="op">(</span><span class="st">"regr.mse"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<div class="grViz html-widget html-fill-item" id="htmlwidget-ac96cb3ee4656e2e9ec3" style="width:960px;height:384px;"></div>
<script type="application/json" data-for="htmlwidget-ac96cb3ee4656e2e9ec3">{"x":{"diagram":"\n  digraph Correlated {\n    rankdir=LR;\n    graph [ranksep=1.5];\n    node [shape=circle, style=filled, fontsize=14, width=1.2];\n    \n    X1 [fillcolor=\"lightcoral\", label=\"X₁\n(β=2.0)\"];\n    X2 [fillcolor=\"pink\", label=\"X₂\n(β=0)\"];\n    X3 [fillcolor=\"lightblue\", label=\"X₃\n(β=1.0)\"];\n    X4 [fillcolor=\"lightgray\", label=\"X₄\n(β=0)\"];\n    Y [fillcolor=\"greenyellow\", label=\"Y\", width=1.5];\n    \n    X1 -> X2 [color=red, style=bold, dir=both, label=\"r = 0.7\"];\n    X1 -> Y [label=\"2.0\"];\n    X2 -> Y [style=dashed, color=gray, label=\"0\"];\n    X3 -> Y [label=\"1.0\"];\n    X4 -> Y [style=dashed, color=gray];\n    \n    {rank=source; X1; X3; X4}\n    {rank=same; X2}\n    {rank=sink; Y}\n  }","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script><p class="caption">
DAG for correlated features DGP
</p>
</div>
</div>
<div class="section level2">
<h2 id="variance-correction">Variance-correction<a class="anchor" aria-label="anchor" href="#variance-correction"></a>
</h2>
<p>When we calculate PFI using an appropriate resampling, such as
subsampling with 15 repeats, we can use the approach recommended by
Molnar et al. (2023) based on the proposed correction by Nadeau &amp;
Bengio (2003).</p>
<p>By default, any importance measures’ <code>$importance()</code>
method will not output any variances or confidence intervals, it will
merely compute averages over resampling iterations and repeats within
resamplings (<code>iter_repeat</code> here).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pfi</span> <span class="op">=</span> <span class="va"><a href="../reference/PFI.html">PFI</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task</span>,</span>
<span>    learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>    resampling <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">rsmp</a></span><span class="op">(</span><span class="st">"subsampling"</span>, repeats <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>,</span>
<span>    measure <span class="op">=</span> <span class="va">measure</span>,</span>
<span>    n_repeats <span class="op">=</span> <span class="fl">20</span> <span class="co"># for stability within resampling iters</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">pfi</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">pfi</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;    feature   importance</span></span>
<span><span class="co">#&gt;     &lt;char&gt;        &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      x1  6.476555494</span></span>
<span><span class="co">#&gt; 2:      x2  0.095842584</span></span>
<span><span class="co">#&gt; 3:      x3  1.793989195</span></span>
<span><span class="co">#&gt; 4:      x4 -0.000962437</span></span></code></pre></div>
<p>If we want <strong>unadjusted</strong> confidence intervals based on
a t-distribution, we can ask for them, but note these are too narrow /
optimistic and hence invalid for inference:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pfi_ci_raw</span> <span class="op">=</span> <span class="va">pfi</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span>ci_method <span class="op">=</span> <span class="st">"raw"</span>, alternative <span class="op">=</span> <span class="st">"two.sided"</span><span class="op">)</span></span>
<span><span class="va">pfi_ci_raw</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;    feature   importance           se  statistic      p.value  conf_lower</span></span>
<span><span class="co">#&gt;     &lt;char&gt;        &lt;num&gt;        &lt;num&gt;      &lt;num&gt;        &lt;num&gt;       &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      x1  6.476555494 0.0707450088  91.547879 7.519530e-21  6.32482254</span></span>
<span><span class="co">#&gt; 2:      x2  0.095842584 0.0042155496  22.735490 1.879277e-12  0.08680113</span></span>
<span><span class="co">#&gt; 3:      x3  1.793989195 0.0132950768 134.936355 3.311520e-23  1.76547409</span></span>
<span><span class="co">#&gt; 4:      x4 -0.000962437 0.0002849623  -3.377418 4.511052e-03 -0.00157362</span></span>
<span><span class="co">#&gt;       conf_upper</span></span>
<span><span class="co">#&gt;            &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:  6.6282884472</span></span>
<span><span class="co">#&gt; 2:  0.1048840389</span></span>
<span><span class="co">#&gt; 3:  1.8225042988</span></span>
<span><span class="co">#&gt; 4: -0.0003512536</span></span></code></pre></div>
<p>The parametric CI methods (<code>"raw"</code> and
<code>"nadeau_bengio"</code>) return <code>se</code>,
<code>statistic</code>, <code>p.value</code>, <code>conf_lower</code>,
and <code>conf_upper</code>. The <code>alternative</code> parameter
controls whether a one-sided test (<code>"greater"</code>, the default,
testing H0: importance &lt;= 0) or two-sided test
(<code>"two.sided"</code>) is performed. Here we use
<code>alternative = "two.sided"</code> for visualization purposes so
that <code>conf_upper</code> is finite.</p>
<p>Analogously we can retrieve the <strong>Nadeau &amp;
Bengio</strong>-adjusted standard errors and derived confidence
intervals which were demonstrated to have better (but still imperfect)
coverage:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pfi_ci_corrected</span> <span class="op">=</span> <span class="va">pfi</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span>ci_method <span class="op">=</span> <span class="st">"nadeau_bengio"</span>, alternative <span class="op">=</span> <span class="st">"two.sided"</span><span class="op">)</span></span>
<span><span class="va">pfi_ci_corrected</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;    feature   importance           se statistic      p.value   conf_lower</span></span>
<span><span class="co">#&gt;     &lt;char&gt;        &lt;num&gt;        &lt;num&gt;     &lt;num&gt;        &lt;num&gt;        &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      x1  6.476555494 0.2063236235 31.390276 2.231930e-14  6.034035333</span></span>
<span><span class="co">#&gt; 2:      x2  0.095842584 0.0122944003  7.795629 1.848448e-06  0.069473718</span></span>
<span><span class="co">#&gt; 3:      x3  1.793989195 0.0387743032 46.267477 1.027030e-16  1.710826586</span></span>
<span><span class="co">#&gt; 4:      x4 -0.000962437 0.0008310757 -1.158062 2.662136e-01 -0.002744917</span></span>
<span><span class="co">#&gt;      conf_upper</span></span>
<span><span class="co">#&gt;           &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: 6.9190756552</span></span>
<span><span class="co">#&gt; 2: 0.1222114505</span></span>
<span><span class="co">#&gt; 3: 1.8771518043</span></span>
<span><span class="co">#&gt; 4: 0.0008200431</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="empirical-quantiles">Empirical quantiles<a class="anchor" aria-label="anchor" href="#empirical-quantiles"></a>
</h2>
<p>Both <code>"raw"</code> and <code>"nadeau_bengio"</code> methods
assume normally distributed importance scores and use parametric
confidence intervals based on the t-distribution. As an alternative, we
can use empirical quantiles to construct confidence-like intervals
without parametric assumptions.</p>
<p>The <code>"quantile"</code> method returns only confidence bounds
(<code>conf_lower</code>, <code>conf_upper</code>) without
<code>se</code>, <code>statistic</code>, or <code>p.value</code>, as
empirical quantiles and hypothesis testing require different
methodologies.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pfi_ci_quantile</span> <span class="op">=</span> <span class="va">pfi</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span>ci_method <span class="op">=</span> <span class="st">"quantile"</span>, alternative <span class="op">=</span> <span class="st">"two.sided"</span><span class="op">)</span></span>
<span><span class="va">pfi_ci_quantile</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;    feature   importance   conf_lower   conf_upper</span></span>
<span><span class="co">#&gt;     &lt;char&gt;        &lt;num&gt;        &lt;num&gt;        &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      x1  6.476555494  6.108602488 6.8752121255</span></span>
<span><span class="co">#&gt; 2:      x2  0.095842584  0.071144370 0.1213703258</span></span>
<span><span class="co">#&gt; 3:      x3  1.793989195  1.736434146 1.8848348302</span></span>
<span><span class="co">#&gt; 4:      x4 -0.000962437 -0.003342628 0.0006686405</span></span></code></pre></div>
<p>To highlight the differences between parametric and empirical
approaches, we visualize all methods:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pfi_cis</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        <span class="va">pfi_ci_raw</span><span class="op">[</span>, <span class="va">type</span> <span class="op">:=</span> <span class="st">"raw"</span><span class="op">]</span>,</span>
<span>        <span class="va">pfi_ci_corrected</span><span class="op">[</span>, <span class="va">type</span> <span class="op">:=</span> <span class="st">"nadeau_bengio"</span><span class="op">]</span>,</span>
<span>        <span class="va">pfi_ci_quantile</span><span class="op">[</span>, <span class="va">type</span> <span class="op">:=</span> <span class="st">"quantile"</span><span class="op">]</span></span>
<span>    <span class="op">)</span>,</span>
<span>    fill <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">pfi_cis</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">feature</span>, color <span class="op">=</span> <span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_errorbar</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">conf_lower</span>, xmax <span class="op">=</span> <span class="va">conf_upper</span><span class="op">)</span>,</span>
<span>        position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span>,</span>
<span>        width <span class="op">=</span> <span class="fl">.5</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">importance</span><span class="op">)</span>, position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_color_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Set2"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>        title <span class="op">=</span> <span class="st">"Parametric &amp; non-parametric CI methods"</span>,</span>
<span>        subtitle <span class="op">=</span> <span class="st">"RF with 15 subsampling iterations"</span>,</span>
<span>        color <span class="op">=</span> <span class="cn">NULL</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<p><img src="inference_files/figure-html/pfi-ci-comparison-1.png" class="r-plt" alt="Point-and-whisker plot with features on y-axis and importance on x-axis. Three colored points for raw, nadeau_bengio, and quantile CI methods, each showing point estimates with horizontal error bars." width="768"></p>
<p>The results highlight just how optimistic the unadjusted, raw
confidence intervals are.</p>
</div>
<div class="section level2">
<h2 id="conditional-predictive-impact-cpi">Conditional predictive impact (CPI)<a class="anchor" aria-label="anchor" href="#conditional-predictive-impact-cpi"></a>
</h2>
<p>CPI (Conditional Predictive Impact) was introduced by Watson &amp;
Wright (2021) for statistical inference with conditional feature
importance using knockoffs. Two main approaches are supported:</p>
<ul>
<li>
<strong>CPI with knockoffs</strong>: The original method using
model-X knockoffs for conditional sampling.</li>
<li>
<strong>cARFi</strong> (Blesch et al., 2025): Uses Adversarial
Random Forests for conditional sampling, which works without Gaussian
assumptions and supports mixed data. CPI is also implemented by <a href="https://bips-hb.github.io/cpi/articles/intro.html" class="external-link">the cpi
package</a>. It works with <code>mlr3</code> and its output on our data
looks like this:</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bips-hb/cpi" class="external-link">cpi</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">resampling</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">resampling</span><span class="op">$</span><span class="fu">instantiate</span><span class="op">(</span><span class="va">task</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cpi_res</span> <span class="op">=</span> <span class="fu"><a href="https://bips-hb.github.io/cpi/reference/cpi.html" class="external-link">cpi</a></span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task</span>,</span>
<span>    learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>    resampling <span class="op">=</span> <span class="va">resampling</span>,</span>
<span>    measure <span class="op">=</span> <span class="va">measure</span>,</span>
<span>    test <span class="op">=</span> <span class="st">"t"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/setDT.html" class="external-link">setDT</a></span><span class="op">(</span><span class="va">cpi_res</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/setattr.html" class="external-link">setnames</a></span><span class="op">(</span><span class="va">cpi_res</span>, <span class="st">"Variable"</span>, <span class="st">"feature"</span><span class="op">)</span></span>
<span><span class="va">cpi_res</span><span class="op">[</span>, <span class="va">method</span> <span class="op">:=</span> <span class="st">"CPI"</span><span class="op">]</span></span>
<span></span>
<span><span class="va">cpi_res</span></span>
<span><span class="co">#&gt;    feature           CPI          SE   test  statistic      estimate</span></span>
<span><span class="co">#&gt;     &lt;char&gt;         &lt;num&gt;       &lt;num&gt; &lt;char&gt;      &lt;num&gt;         &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      x1  4.5092929912 0.147978747      t 30.4725717  4.5092929912</span></span>
<span><span class="co">#&gt; 2:      x2  0.0029567621 0.003362453      t  0.8793467  0.0029567621</span></span>
<span><span class="co">#&gt; 3:      x3  1.8536055915 0.060102228      t 30.8408797  1.8536055915</span></span>
<span><span class="co">#&gt; 4:      x4 -0.0008885688 0.000770307      t -1.1535255 -0.0008885688</span></span>
<span><span class="co">#&gt;          p.value        ci.lo method</span></span>
<span><span class="co">#&gt;            &lt;num&gt;        &lt;num&gt; &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1: 3.859678e-168  4.265776760    CPI</span></span>
<span><span class="co">#&gt; 2:  1.896595e-01 -0.002576545    CPI</span></span>
<span><span class="co">#&gt; 3: 1.768282e-171  1.754700388    CPI</span></span>
<span><span class="co">#&gt; 4:  8.755837e-01 -0.002156198    CPI</span></span></code></pre></div>
<div class="section level3">
<h3 id="cpi-with-knockoffs">CPI with knockoffs<a class="anchor" aria-label="anchor" href="#cpi-with-knockoffs"></a>
</h3>
<p>Since <code>xplainfi</code> also includes knockoffs via the
<code>KnockoffSampler</code> and the
<code>KnockoffGaussianSampler</code>, the latter implementing the second
order Gaussian knockoffs also used by default in <a href="https://github.com/bips-hb/cpi" class="external-link">cpi</a>, we
can recreate its results using <code>CFI</code> with the corresponding
<code>sampler</code>.</p>
<p><code>CFI</code> with a knockoff sampler supports CPI inference
directly via <code>ci_method = "cpi"</code>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">knockoff_gaussian</span> <span class="op">=</span> <span class="va"><a href="../reference/KnockoffGaussianSampler.html">KnockoffGaussianSampler</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">task</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cfi</span> <span class="op">=</span> <span class="va"><a href="../reference/CFI.html">CFI</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task</span>,</span>
<span>    learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>    resampling <span class="op">=</span> <span class="va">resampling</span>,</span>
<span>    measure <span class="op">=</span> <span class="va">measure</span>,</span>
<span>    sampler <span class="op">=</span> <span class="va">knockoff_gaussian</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Requested `n_repeats = 30` permutations with <span style="color: #0000BB;">&lt;KnockoffGaussianSampler&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> A <span style="color: #0000BB;">&lt;KnockoffSampler&gt;</span> was constructed with <span style="color: #0000BB;">1</span> iterations</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Proceeding with `n_repeats = 1`</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Reconstruct <span style="color: #0000BB;">&lt;KnockoffGaussianSampler&gt;</span> with `iters &gt;= 30` or use</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">&lt;ConditionalARFSampler&gt;</span> if repeated sampling is required.</span></span>
<span></span>
<span><span class="va">cfi</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># CPI uses observation-wise losses; default is one-sided test (alternative = "greater")</span></span>
<span><span class="va">cfi_cpi_res</span> <span class="op">=</span> <span class="va">cfi</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span>ci_method <span class="op">=</span> <span class="st">"cpi"</span><span class="op">)</span></span>
<span><span class="va">cfi_cpi_res</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;    feature   importance           se  statistic       p.value   conf_lower</span></span>
<span><span class="co">#&gt;     &lt;char&gt;        &lt;num&gt;        &lt;num&gt;      &lt;num&gt;         &lt;num&gt;        &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      x1  4.362355571 0.1355320358 32.1868962 8.486605e-184  4.139321851</span></span>
<span><span class="co">#&gt; 2:      x2  0.001742650 0.0029223989  0.5963079  2.755185e-01 -0.003066498</span></span>
<span><span class="co">#&gt; 3:      x3  1.769344462 0.0548657780 32.2485988 2.290447e-184  1.679056446</span></span>
<span><span class="co">#&gt; 4:      x4 -0.000470146 0.0009370589 -0.5017251  6.920419e-01 -0.002012185</span></span>
<span><span class="co">#&gt;    conf_upper</span></span>
<span><span class="co">#&gt;         &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:        Inf</span></span>
<span><span class="co">#&gt; 2:        Inf</span></span>
<span><span class="co">#&gt; 3:        Inf</span></span>
<span><span class="co">#&gt; 4:        Inf</span></span>
<span></span>
<span><span class="co"># Rename columns to match cpi package output for comparison</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/setattr.html" class="external-link">setnames</a></span><span class="op">(</span><span class="va">cfi_cpi_res</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"importance"</span>, <span class="st">"conf_lower"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CPI"</span>, <span class="st">"ci.lo"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cfi_cpi_res</span><span class="op">[</span>, <span class="va">method</span> <span class="op">:=</span> <span class="st">"CFI+Knockoffs"</span><span class="op">]</span></span></code></pre></div>
<p>The results should be very similar to those computed by
<code><a href="https://bips-hb.github.io/cpi/reference/cpi.html" class="external-link">cpi()</a></code>, so let’s compare them:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">cpi_res</span>, <span class="va">cfi_cpi_res</span><span class="op">)</span>, fill <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">feature</span>, x <span class="op">=</span> <span class="va">CPI</span>, color <span class="op">=</span> <span class="va">method</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_errorbar</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">CPI</span>, xmax <span class="op">=</span> <span class="va">ci.lo</span><span class="op">)</span>,</span>
<span>        position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span>,</span>
<span>        width <span class="op">=</span> <span class="fl">0.5</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_color_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Dark2"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>        title <span class="op">=</span> <span class="st">"CPI and CFI with Knockoff sampler"</span>,</span>
<span>        subtitle <span class="op">=</span> <span class="st">"RF with 5-fold CV"</span>,</span>
<span>        color <span class="op">=</span> <span class="cn">NULL</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span></span></code></pre></div>
<p><img src="inference_files/figure-html/cpi-cfi-plot-1.png" class="r-plt" alt="Point-and-whisker plot with features on y-axis and CPI values on x-axis. Two colored points for CPI and CFI+Knockoffs methods with horizontal error bars." width="768"></p>
<p>A noteable caveat of the knockoff approach is that they are not
readily available for mixed data (with categorical features).</p>
</div>
<div class="section level3">
<h3 id="carfi-cpi-with-arf">cARFi: CPI with ARF<a class="anchor" aria-label="anchor" href="#carfi-cpi-with-arf"></a>
</h3>
<p>An alternative is available using ARF as conditional sampler rather
than knockoffs. This approach, called cARFi, was introduced by <a href="https://doi.org/10.1609/aaai.v39i15.33712" class="external-link">Blesch et
al. (2025)</a> and works without Gaussian assumptions:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">arf_sampler</span> <span class="op">=</span> <span class="va"><a href="../reference/ConditionalARFSampler.html">ConditionalARFSampler</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task</span>,</span>
<span>    finite_bounds <span class="op">=</span> <span class="st">"local"</span>,</span>
<span>    min_node_size <span class="op">=</span> <span class="fl">20</span>,</span>
<span>    epsilon <span class="op">=</span> <span class="fl">1e-15</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">cfi_arf</span> <span class="op">=</span> <span class="va"><a href="../reference/CFI.html">CFI</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task</span>,</span>
<span>    learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>    resampling <span class="op">=</span> <span class="va">resampling</span>,</span>
<span>    measure <span class="op">=</span> <span class="va">measure</span>,</span>
<span>    sampler <span class="op">=</span> <span class="va">arf_sampler</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">cfi_arf</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># CPI inference with ARF sampler (cARFi)</span></span>
<span><span class="va">cfi_arf_res</span> <span class="op">=</span> <span class="va">cfi_arf</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span>ci_method <span class="op">=</span> <span class="st">"cpi"</span><span class="op">)</span></span>
<span><span class="va">cfi_arf_res</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;    feature    importance           se statistic    p.value   conf_lower</span></span>
<span><span class="co">#&gt;     &lt;char&gt;         &lt;num&gt;        &lt;num&gt;     &lt;num&gt;      &lt;num&gt;        &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      x1  3.9865071718 0.0715166883 55.742335 0.00000000  3.868818148</span></span>
<span><span class="co">#&gt; 2:      x2  0.0053611218 0.0025570164  2.096632 0.01807579  0.001153254</span></span>
<span><span class="co">#&gt; 3:      x3  1.7527732858 0.0325190020 53.899972 0.00000000  1.699259488</span></span>
<span><span class="co">#&gt; 4:      x4 -0.0009391978 0.0004918991 -1.909330 0.97181872 -0.001748675</span></span>
<span><span class="co">#&gt;    conf_upper</span></span>
<span><span class="co">#&gt;         &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:        Inf</span></span>
<span><span class="co">#&gt; 2:        Inf</span></span>
<span><span class="co">#&gt; 3:        Inf</span></span>
<span><span class="co">#&gt; 4:        Inf</span></span>
<span></span>
<span><span class="co"># Rename columns to match cpi package output for comparison</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/setattr.html" class="external-link">setnames</a></span><span class="op">(</span><span class="va">cfi_arf_res</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"importance"</span>, <span class="st">"conf_lower"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CPI"</span>, <span class="st">"ci.lo"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cfi_arf_res</span><span class="op">[</span>, <span class="va">method</span> <span class="op">:=</span> <span class="st">"CFI+ARF"</span><span class="op">]</span></span></code></pre></div>
<p>We can now compare all three methods:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">cpi_res</span>, <span class="va">cfi_cpi_res</span>, <span class="va">cfi_arf_res</span><span class="op">)</span>, fill <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">feature</span>, x <span class="op">=</span> <span class="va">CPI</span>, color <span class="op">=</span> <span class="va">method</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_errorbar</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">CPI</span>, xmax <span class="op">=</span> <span class="va">ci.lo</span><span class="op">)</span>,</span>
<span>        position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span>,</span>
<span>        width <span class="op">=</span> <span class="fl">0.5</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_color_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Dark2"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>        title <span class="op">=</span> <span class="st">"CPI and CFI with Knockoffs and ARF"</span>,</span>
<span>        subtitle <span class="op">=</span> <span class="st">"RF with 5-fold CV"</span>,</span>
<span>        color <span class="op">=</span> <span class="cn">NULL</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span></span></code></pre></div>
<p><img src="inference_files/figure-html/cpi-cfi-arf-plot-1.png" class="r-plt" alt="Point-and-whisker plot with features on y-axis and CPI values on x-axis. Three colored points for CPI, CFI+Knockoffs, and CFI+ARF methods with horizontal error bars." width="768"></p>
<p>As expected, the ARF-based approach differs more from both
knockoff-based approaches, but they are all roughly in agreement.</p>
</div>
<div class="section level3">
<h3 id="statistical-tests-with-cpi">Statistical tests with CPI<a class="anchor" aria-label="anchor" href="#statistical-tests-with-cpi"></a>
</h3>
<p>CPI can also perform additional tests besides the default t-test,
specifically the Wilcoxon-, Fisher-, or binomial test:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">cpi_res_wilcoxon</span> <span class="op">=</span> <span class="va">cfi_arf</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span>ci_method <span class="op">=</span> <span class="st">"cpi"</span>, test <span class="op">=</span> <span class="st">"wilcoxon"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;    feature    importance           se statistic      p.value    conf_lower</span></span>
<span><span class="co">#&gt;     &lt;char&gt;         &lt;num&gt;        &lt;num&gt;     &lt;num&gt;        &lt;num&gt;         &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      x1  3.9865071718 0.0715166883   2001000 0.000000e+00  3.2285614819</span></span>
<span><span class="co">#&gt; 2:      x2  0.0053611218 0.0025570164   1194853 2.647776e-14  0.0031150313</span></span>
<span><span class="co">#&gt; 3:      x3  1.7527732858 0.0325190020   2000886 0.000000e+00  1.4036366255</span></span>
<span><span class="co">#&gt; 4:      x4 -0.0009391978 0.0004918991   1031351 1.161633e-01 -0.0001004833</span></span>
<span><span class="co">#&gt;    conf_upper</span></span>
<span><span class="co">#&gt;         &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:        Inf</span></span>
<span><span class="co">#&gt; 2:        Inf</span></span>
<span><span class="co">#&gt; 3:        Inf</span></span>
<span><span class="co">#&gt; 4:        Inf</span></span>
<span><span class="co"># Fisher test with same default for B as in cpi()</span></span>
<span><span class="op">(</span><span class="va">cpi_res_fisher</span> <span class="op">=</span> <span class="va">cfi_arf</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span>ci_method <span class="op">=</span> <span class="st">"cpi"</span>, test <span class="op">=</span> <span class="st">"fisher"</span>, B <span class="op">=</span> <span class="fl">1999</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;    feature    importance           se     statistic p.value   conf_lower</span></span>
<span><span class="co">#&gt;     &lt;char&gt;         &lt;num&gt;        &lt;num&gt;         &lt;num&gt;   &lt;num&gt;        &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      x1  3.9865071718 0.0715166883  3.9865071718  0.0005  3.802012761</span></span>
<span><span class="co">#&gt; 2:      x2  0.0053611218 0.0025570164  0.0053611218  0.0215  0.001095074</span></span>
<span><span class="co">#&gt; 3:      x3  1.7527732858 0.0325190020  1.7527732858  0.0005  1.668688790</span></span>
<span><span class="co">#&gt; 4:      x4 -0.0009391978 0.0004918991 -0.0009391978  0.9670 -0.001773247</span></span>
<span><span class="co">#&gt;    conf_upper</span></span>
<span><span class="co">#&gt;         &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:        Inf</span></span>
<span><span class="co">#&gt; 2:        Inf</span></span>
<span><span class="co">#&gt; 3:        Inf</span></span>
<span><span class="co">#&gt; 4:        Inf</span></span>
<span><span class="op">(</span><span class="va">cpi_res_binom</span> <span class="op">=</span> <span class="va">cfi_arf</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span>ci_method <span class="op">=</span> <span class="st">"cpi"</span>, test <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;    feature    importance           se statistic      p.value conf_lower</span></span>
<span><span class="co">#&gt;     &lt;char&gt;         &lt;num&gt;        &lt;num&gt;     &lt;num&gt;        &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      x1  3.9865071718 0.0715166883      2000 0.000000e+00  0.9985033</span></span>
<span><span class="co">#&gt; 2:      x2  0.0053611218 0.0025570164      1215 2.994368e-22  0.5891816</span></span>
<span><span class="co">#&gt; 3:      x3  1.7527732858 0.0325190020      1995 0.000000e+00  0.9947507</span></span>
<span><span class="co">#&gt; 4:      x4 -0.0009391978 0.0004918991      1094 1.430053e-05  0.5283991</span></span>
<span><span class="co">#&gt;    conf_upper</span></span>
<span><span class="co">#&gt;         &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:          1</span></span>
<span><span class="co">#&gt; 2:          1</span></span>
<span><span class="co">#&gt; 3:          1</span></span>
<span><span class="co">#&gt; 4:          1</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        <span class="va">cfi_arf</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span>ci_method <span class="op">=</span> <span class="st">"cpi"</span><span class="op">)</span><span class="op">[</span>, <span class="va">test</span> <span class="op">:=</span> <span class="st">"t"</span><span class="op">]</span>,</span>
<span>        <span class="va">cpi_res_wilcoxon</span><span class="op">[</span>, <span class="va">test</span> <span class="op">:=</span> <span class="st">"Wilcoxon"</span><span class="op">]</span>,</span>
<span>        <span class="va">cpi_res_fisher</span><span class="op">[</span>, <span class="va">test</span> <span class="op">:=</span> <span class="st">"Fisher"</span><span class="op">]</span>,</span>
<span>        <span class="va">cpi_res_binom</span><span class="op">[</span>, <span class="va">test</span> <span class="op">:=</span> <span class="st">"Binomial"</span><span class="op">]</span></span>
<span>    <span class="op">)</span>,</span>
<span>    fill <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">feature</span>, x <span class="op">=</span> <span class="va">importance</span>, color <span class="op">=</span> <span class="va">test</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_errorbar</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">importance</span>, xmax <span class="op">=</span> <span class="va">conf_lower</span><span class="op">)</span>,</span>
<span>        position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span>,</span>
<span>        width <span class="op">=</span> <span class="fl">0.5</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_color_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Dark2"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>        title <span class="op">=</span> <span class="st">"CPI test with CFI/ARF"</span>,</span>
<span>        subtitle <span class="op">=</span> <span class="st">"RF with 5-fold CV"</span>,</span>
<span>        color <span class="op">=</span> <span class="st">"Test"</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span></span></code></pre></div>
<p><img src="inference_files/figure-html/cpi-tests-1.png" class="r-plt" alt="Point-and-whisker plot with features on y-axis and importance on x-axis. Four colored series for t, Wilcoxon, Fisher, and Binomial tests with horizontal error bars." width="768"></p>
<p>The choice of test depends on distributional assumptions: the t-test
assumes normality, while Fisher and Wilcoxon are non-parametric
alternatives.</p>
</div>
</div>
<div class="section level2">
<h2 id="custom-inference-with-loco">Custom inference with LOCO<a class="anchor" aria-label="anchor" href="#custom-inference-with-loco"></a>
</h2>
<p><a href="https://doi.org/10.1080/01621459.2017.1307116" class="external-link">Lei et
al. (2018)</a> proposed inference for LOCO using the median absolute
differences of the baseline- and post-refit loss differences</p>
<p><span class="math display">\[
\theta_j = \mathrm{med}\left(
    |Y - \hat{f}_{n_1}^{-j}(X)| - |Y - \hat{f}_{n_1}(X)| \big| D_1
\right)
\]</span></p>
<p>If we apply <code>LOCO</code> as implemented in <code>xplainfi</code>
using the median absolute error (MAE) as our measure including the
median as the aggregation function, we unfortunately get something else,
though:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">measure_mae</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">msr</a></span><span class="op">(</span><span class="st">"regr.mae"</span><span class="op">)</span></span>
<span><span class="va">measure_mae</span><span class="op">$</span><span class="va">aggregator</span> <span class="op">=</span> <span class="va">median</span></span>
<span></span>
<span><span class="va">loco</span> <span class="op">=</span> <span class="va"><a href="../reference/LOCO.html">LOCO</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task</span>,</span>
<span>    learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>    resampling <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">rsmp</a></span><span class="op">(</span><span class="st">"holdout"</span><span class="op">)</span>,</span>
<span>    measure <span class="op">=</span> <span class="va">measure_mae</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">loco</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">loco</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;    feature importance</span></span>
<span><span class="co">#&gt;     &lt;char&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      x1 0.98413241</span></span>
<span><span class="co">#&gt; 2:      x2 0.04153689</span></span>
<span><span class="co">#&gt; 3:      x3 0.60559674</span></span>
<span><span class="co">#&gt; 4:      x4 0.04711029</span></span></code></pre></div>
<p>This is <strong>not</strong> exactly what the authors propose,
because <code>$score()</code> calculates the aggregation function
(<code>median</code>) for each resampling iteration first, and takes the
difference afterwards, i.e.</p>
<p><span class="math display">\[
\theta_j = \mathrm{med}\left(|Y - \hat{f}_{n_1}^{-j}(X)|\right) -
\mathrm{med}\left(|Y - \hat{f}_{n_1}(X)| \big| D_1
\right)
\]</span></p>
<p>In the default case where the arithemtic mean is used, it does not
matter whether we calculate the difference of the means or the mean of
the differences, but using the median it does.</p>
<p>We can, however, reconstruct it by using the observation-wise losses
(in this case, the absolute error):</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">loco_obsloss</span> <span class="op">=</span> <span class="va">loco</span><span class="op">$</span><span class="fu">obs_loss</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">loco_obsloss</span><span class="op">)</span></span>
<span><span class="co">#&gt;    feature iter_rsmp iter_repeat row_ids loss_baseline loss_post obs_importance</span></span>
<span><span class="co">#&gt;     &lt;char&gt;     &lt;int&gt;       &lt;num&gt;   &lt;int&gt;         &lt;num&gt;     &lt;num&gt;          &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      x1         1           2       1    0.06837518 0.3866730     0.31829787</span></span>
<span><span class="co">#&gt; 2:      x1         1           2       3    0.33656952 0.4282341     0.09166453</span></span>
<span><span class="co">#&gt; 3:      x1         1           2      14    0.14554173 1.2629784     1.11743664</span></span>
<span><span class="co">#&gt; 4:      x1         1           2      18    0.21779867 0.6605524     0.44275371</span></span>
<span><span class="co">#&gt; 5:      x1         1           2      25    0.07254430 1.0481222     0.97557794</span></span>
<span><span class="co">#&gt; 6:      x1         1           2      28    0.22369548 1.0455213     0.82182579</span></span></code></pre></div>
<p><code>obs_importance</code> here refers to the difference
<code>loss_post - loss_baseline</code>, so</p>
<ul>
<li><span class="math inline">\(\texttt{loss_baseline} = |Y -
\hat{f}_{n_1}(X)|\)</span></li>
<li><span class="math inline">\(\texttt{loss_post} = |Y -
\hat{f}_{n_1}^{-j}(X)|\)</span></li>
<li><span class="math inline">\(\texttt{obs_importance} =
\texttt{loss_post} - \texttt{loss_baseline}\)</span></li>
</ul>
<p>Which means by taking the median for each feature <span class="math inline">\(j\)</span> within each resampling iteration, we
can construct <span class="math inline">\(\theta_j(D_1)\)</span> as
proposed, for each set <span class="math inline">\(D_k\)</span> where
<span class="math inline">\(k\)</span> is the resampling iteration:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">loco_thetas</span> <span class="op">=</span> <span class="va">loco_obsloss</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">obs_importance</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"feature"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">loco_thetas</span></span>
<span><span class="co">#&gt;    feature      theta</span></span>
<span><span class="co">#&gt;     &lt;char&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      x1 0.79280654</span></span>
<span><span class="co">#&gt; 2:      x2 0.01851736</span></span>
<span><span class="co">#&gt; 3:      x3 0.52224336</span></span>
<span><span class="co">#&gt; 4:      x4 0.02133066</span></span></code></pre></div>
<p>The authors then propose to construct distribution-free confidence
intervals, e.g. using a sign- or Wilcoxon test We can for example use
<code>wilcoxon.test()</code> to compute confidence intervals around the
estimated pseudo-median:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">loco_wilcox_ci</span> <span class="op">=</span> <span class="va">loco_obsloss</span><span class="op">[</span>,</span>
<span>    <span class="op">{</span></span>
<span>        <span class="va">tt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/wilcox.test.html" class="external-link">wilcox.test</a></span><span class="op">(</span></span>
<span>            <span class="va">obs_importance</span>,</span>
<span>            conf.int <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>            conf.level <span class="op">=</span> <span class="fl">0.95</span></span>
<span>        <span class="op">)</span></span>
<span>        <span class="fu">.</span><span class="op">(</span></span>
<span>            statistic <span class="op">=</span> <span class="va">tt</span><span class="op">$</span><span class="va">statistic</span>,</span>
<span>            estimate <span class="op">=</span> <span class="va">tt</span><span class="op">$</span><span class="va">estimate</span>, <span class="co"># the pseudomedian importance</span></span>
<span>            p.value <span class="op">=</span> <span class="va">tt</span><span class="op">$</span><span class="va">p.value</span>,</span>
<span>            conf_lower <span class="op">=</span> <span class="va">tt</span><span class="op">$</span><span class="va">conf.int</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>            conf_upper <span class="op">=</span> <span class="va">tt</span><span class="op">$</span><span class="va">conf.int</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    by <span class="op">=</span> <span class="va">feature</span></span>
<span><span class="op">]</span></span>
<span></span>
<span><span class="va">loco_wilcox_ci</span></span>
<span><span class="co">#&gt;    feature statistic   estimate       p.value conf_lower conf_upper</span></span>
<span><span class="co">#&gt;     &lt;char&gt;     &lt;num&gt;      &lt;num&gt;         &lt;num&gt;      &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      x1 194641130 0.90926043  0.000000e+00 0.89581673 0.92270736</span></span>
<span><span class="co">#&gt; 2:      x2 121302167 0.02405662 2.317954e-148 0.02219018 0.02590611</span></span>
<span><span class="co">#&gt; 3:      x3 190309637 0.57687593  0.000000e+00 0.56827659 0.58544169</span></span>
<span><span class="co">#&gt; 4:      x4 134365884 0.03178195  0.000000e+00 0.03022359 0.03337264</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://lukasburk.de" class="external-link">Lukas Burk</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
