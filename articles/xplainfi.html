<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Getting Started with xplainfi • xplainfi</title>
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Roboto-0.4.10/font.css" rel="stylesheet">
<link href="../deps/JetBrains_Mono-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Roboto_Slab-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Getting Started with xplainfi">
<script defer src="https://umami.jemu.name/script.js" data-website-id="248c8668-4908-4c63-86f7-db0a1b19758a"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">xplainfi</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/xplainfi.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><h6 class="dropdown-header" data-toc-skip>Method Showcase</h6></li>
    <li><a class="dropdown-item" href="../articles/perturbation-importance.html">Perturbation-Based Methods (PFI, CFI, RFI)</a></li>
    <li><a class="dropdown-item" href="../articles/loco.html">Model Refitting Measures (LOCO, WVIM)</a></li>
    <li><a class="dropdown-item" href="../articles/sage-methods.html">Shapley Additive Global Importance (SAGE)</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Specialized Topics</h6></li>
    <li><a class="dropdown-item" href="../articles/feature-samplers.html">Feature Samplers</a></li>
    <li><a class="dropdown-item" href="../articles/inference.html">Inference for Feature Importances</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Testing &amp; Validation</h6></li>
    <li><a class="dropdown-item" href="../articles/simulation-settings.html">Simulation Settings</a></li>
    <li><a class="dropdown-item" href="../articles/fippy-comparison.html">Comparison with fippy (Python)</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mlr-org/xplainfi/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Getting Started with xplainfi</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mlr-org/xplainfi/blob/main/vignettes/xplainfi.Rmd" class="external-link"><code>vignettes/xplainfi.Rmd</code></a></small>
      <div class="d-none name"><code>xplainfi.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr-org.github.io/xplainfi/" class="external-link">xplainfi</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3.mlr-org.com" class="external-link">mlr3</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3learners.mlr-org.com" class="external-link">mlr3learners</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<p>The <strong>xplainfi</strong> package provides feature importance
methods for machine learning models. It implements several approaches
for measuring how much each feature contributes to model predictions,
with a focus on model-agnostic methods that work with any learner.</p>
<div class="section level2">
<h2 id="core-concepts">Core Concepts<a class="anchor" aria-label="anchor" href="#core-concepts"></a>
</h2>
<p>Feature importance methods in xplainfi address different but related
questions:</p>
<ul>
<li>
<strong>How much does each feature contribute to model
performance?</strong> (Permutation Feature Importance)</li>
<li>
<strong>What happens when we remove features and retrain?</strong>
(Leave-One-Covariate-Out)<br>
</li>
<li>
<strong>How do features depend on each other?</strong> (Conditional
and Relative methods)</li>
</ul>
<p>All methods share a common interface built on <a href="https://mlr3.mlr-org.com/" class="external-link">mlr3</a>, making them easy to use with
any task, learner, measure, and resampling strategy.</p>
<p>The general pattern is to call <code>$compute()</code> to calculate
importance (which <em>always re-computes</em>), then
<code>$importance()</code> to retrieve the aggregated results, with
intermediate results available in <code>$scores()</code> and, if the
chosen measures supports it, <code>$obs_loss()</code>.</p>
</div>
<div class="section level2">
<h2 id="basic-example">Basic Example<a class="anchor" aria-label="anchor" href="#basic-example"></a>
</h2>
<p>Let’s use the Friedman1 task, which provides an ideal setup for
demonstrating feature importance methods with known ground truth:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">task</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">tgen</a></span><span class="op">(</span><span class="st">"friedman1"</span><span class="op">)</span><span class="op">$</span><span class="fu">generate</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">300</span><span class="op">)</span></span>
<span><span class="va">learner</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">lrn</a></span><span class="op">(</span><span class="st">"regr.ranger"</span>, num.trees <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">measure</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">msr</a></span><span class="op">(</span><span class="st">"regr.mse"</span><span class="op">)</span></span>
<span><span class="va">resampling</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p>The task has 300 observations with 10 features. Features
<code>important1</code> through <code>important5</code> truly affect the
target, while <code>unimportant1</code> through
<code>unimportant5</code> are pure noise. We’ll use a random forest
learner with cross-validation for more stable estimates.</p>
<p>The target function is: <span class="math inline">\(y = 10 *
\operatorname{sin}(\pi * x_1 * x_2) + 20 * (x_3 - 0.5)^2 + 10 * x_4 + 5
* x_5 + \epsilon\)</span></p>
</div>
<div class="section level2">
<h2 id="permutation-feature-importance-pfi">Permutation Feature Importance (PFI)<a class="anchor" aria-label="anchor" href="#permutation-feature-importance-pfi"></a>
</h2>
<p>PFI is the most straightforward method: for each feature, we permute
(shuffle) its values and measure how much model performance
deteriorates. More important features cause larger performance drops
when shuffled.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pfi</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/PFI.html">PFI</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task</span>,</span>
<span>    learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>    measure <span class="op">=</span> <span class="va">measure</span>,</span>
<span>    resampling <span class="op">=</span> <span class="va">resampling</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">pfi</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">pfi</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;          feature   importance</span></span>
<span><span class="co">#&gt;           &lt;char&gt;        &lt;num&gt;</span></span>
<span><span class="co">#&gt;  1:   important1  4.858724892</span></span>
<span><span class="co">#&gt;  2:   important2  8.155693005</span></span>
<span><span class="co">#&gt;  3:   important3  1.109254345</span></span>
<span><span class="co">#&gt;  4:   important4 10.784727349</span></span>
<span><span class="co">#&gt;  5:   important5  2.395793708</span></span>
<span><span class="co">#&gt;  6: unimportant1  0.009618005</span></span>
<span><span class="co">#&gt;  7: unimportant2  0.080903445</span></span>
<span><span class="co">#&gt;  8: unimportant3  0.044057887</span></span>
<span><span class="co">#&gt;  9: unimportant4 -0.082032243</span></span>
<span><span class="co">#&gt; 10: unimportant5 -0.137666350</span></span></code></pre></div>
<p>The <code>importance</code> column shows the performance difference
when each feature is permuted. Higher values indicate more important
features.</p>
<p>For more stable estimates, we can use multiple permutation iterations
per resampling fold with <code>n_repeats</code>. Note that in this case
“more is more”, and while there is no clear “good enough” value, setting
<code>n_repeats</code> to a small value like 1 will most definitely
yield unreliable results.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pfi_stable</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/PFI.html">PFI</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task</span>,</span>
<span>    learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>    measure <span class="op">=</span> <span class="va">measure</span>,</span>
<span>    resampling <span class="op">=</span> <span class="va">resampling</span>,</span>
<span>    n_repeats <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">pfi_stable</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">pfi_stable</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;          feature   importance</span></span>
<span><span class="co">#&gt;           &lt;char&gt;        &lt;num&gt;</span></span>
<span><span class="co">#&gt;  1:   important1  5.632865193</span></span>
<span><span class="co">#&gt;  2:   important2  8.217424105</span></span>
<span><span class="co">#&gt;  3:   important3  1.127171028</span></span>
<span><span class="co">#&gt;  4:   important4 12.610746815</span></span>
<span><span class="co">#&gt;  5:   important5  2.156205784</span></span>
<span><span class="co">#&gt;  6: unimportant1 -0.002932088</span></span>
<span><span class="co">#&gt;  7: unimportant2  0.004595318</span></span>
<span><span class="co">#&gt;  8: unimportant3  0.052577152</span></span>
<span><span class="co">#&gt;  9: unimportant4  0.066657519</span></span>
<span><span class="co">#&gt; 10: unimportant5 -0.035436306</span></span></code></pre></div>
<p>We can also use ratio instead of difference for the importance
calculation, meaning that an unimportant feature is now expected to get
an importance score of 1 rather than 0:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pfi_stable</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span>relation <span class="op">=</span> <span class="st">"ratio"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;          feature importance</span></span>
<span><span class="co">#&gt;           &lt;char&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt;  1:   important1  1.8557162</span></span>
<span><span class="co">#&gt;  2:   important2  2.2483409</span></span>
<span><span class="co">#&gt;  3:   important3  1.1709915</span></span>
<span><span class="co">#&gt;  4:   important4  2.9043526</span></span>
<span><span class="co">#&gt;  5:   important5  1.3261294</span></span>
<span><span class="co">#&gt;  6: unimportant1  0.9993403</span></span>
<span><span class="co">#&gt;  7: unimportant2  1.0008185</span></span>
<span><span class="co">#&gt;  8: unimportant3  1.0065982</span></span>
<span><span class="co">#&gt;  9: unimportant4  1.0098395</span></span>
<span><span class="co">#&gt; 10: unimportant5  0.9945623</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="leave-one-covariate-out-loco">Leave-One-Covariate-Out (LOCO)<a class="anchor" aria-label="anchor" href="#leave-one-covariate-out-loco"></a>
</h2>
<p>LOCO measures importance by retraining the model without each feature
and comparing performance to the full model. This shows the contribution
of each feature when all other features are present.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">loco</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/LOCO.html">LOCO</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task</span>,</span>
<span>    learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>    measure <span class="op">=</span> <span class="va">measure</span>,</span>
<span>    resampling <span class="op">=</span> <span class="va">resampling</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">loco</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">loco</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;          feature importance</span></span>
<span><span class="co">#&gt;           &lt;char&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt;  1:   important1  3.2146916</span></span>
<span><span class="co">#&gt;  2:   important2  5.2024952</span></span>
<span><span class="co">#&gt;  3:   important3  0.4812675</span></span>
<span><span class="co">#&gt;  4:   important4  7.2416733</span></span>
<span><span class="co">#&gt;  5:   important5  0.3338383</span></span>
<span><span class="co">#&gt;  6: unimportant1 -0.6559862</span></span>
<span><span class="co">#&gt;  7: unimportant2 -0.5292880</span></span>
<span><span class="co">#&gt;  8: unimportant3 -0.7172825</span></span>
<span><span class="co">#&gt;  9: unimportant4 -0.3425903</span></span>
<span><span class="co">#&gt; 10: unimportant5 -0.5959717</span></span></code></pre></div>
<p>LOCO is computationally expensive as it requires retraining for each
feature, but provides clear interpretation: higher values mean larger
performance drop when the feature is removed. LOCO however cannot
distinguish between direct effects and indirect effects through
correlated features.</p>
</div>
<div class="section level2">
<h2 id="feature-samplers">Feature Samplers<a class="anchor" aria-label="anchor" href="#feature-samplers"></a>
</h2>
<p>For advanced methods that account for feature dependencies, xplainfi
provides different sampling strategies. While PFI uses simple
permutation (marginal sampling), conditional samplers can preserve
feature relationships.</p>
<p>Let’s demonstrate conditional sampling using Adversarial Random
Forests, which preserves relationships between features when
sampling:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">arf_sampler</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/ConditionalARFSampler.html">ConditionalARFSampler</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">task</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sample_data</span> <span class="op">&lt;-</span> <span class="va">task</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span>rows <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">sample_data</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">important1</span>, <span class="va">important2</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt;    important1  important2</span></span>
<span><span class="co">#&gt;         &lt;num&gt;       &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:  0.2875775 0.784575267</span></span>
<span><span class="co">#&gt; 2:  0.7883051 0.009429905</span></span>
<span><span class="co">#&gt; 3:  0.4089769 0.779065883</span></span>
<span><span class="co">#&gt; 4:  0.8830174 0.729390652</span></span>
<span><span class="co">#&gt; 5:  0.9404673 0.630131853</span></span></code></pre></div>
<p>Now we’ll conditionally sample the <code>important1</code> feature
given the values of <code>important2</code> and
<code>important3</code>:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sampled_conditional</span> <span class="op">&lt;-</span> <span class="va">arf_sampler</span><span class="op">$</span><span class="fu">sample_newdata</span><span class="op">(</span></span>
<span>    feature <span class="op">=</span> <span class="st">"important1"</span>,</span>
<span>    newdata <span class="op">=</span> <span class="va">sample_data</span>,</span>
<span>    conditioning_set <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"important2"</span>, <span class="st">"important3"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">sample_data</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">important1</span>, <span class="va">important2</span>, <span class="va">important3</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt;    important1  important2 important3</span></span>
<span><span class="co">#&gt;         &lt;num&gt;       &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:  0.2875775 0.784575267  0.2372297</span></span>
<span><span class="co">#&gt; 2:  0.7883051 0.009429905  0.6864904</span></span>
<span><span class="co">#&gt; 3:  0.4089769 0.779065883  0.2258184</span></span>
<span><span class="co">#&gt; 4:  0.8830174 0.729390652  0.3184946</span></span>
<span><span class="co">#&gt; 5:  0.9404673 0.630131853  0.1739838</span></span>
<span><span class="va">sampled_conditional</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">important1</span>, <span class="va">important2</span>, <span class="va">important3</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt;    important1  important2 important3</span></span>
<span><span class="co">#&gt;         &lt;num&gt;       &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:  0.2436298 0.784575267  0.2372297</span></span>
<span><span class="co">#&gt; 2:  0.4299974 0.009429905  0.6864904</span></span>
<span><span class="co">#&gt; 3:  0.8416970 0.779065883  0.2258184</span></span>
<span><span class="co">#&gt; 4:  0.8402944 0.729390652  0.3184946</span></span>
<span><span class="co">#&gt; 5:  0.3115287 0.630131853  0.1739838</span></span></code></pre></div>
<p>This conditional sampling is essential for methods like CFI and RFI
that need to preserve feature dependencies. See
<code>vignette("perturbation-importance")</code> for detailed
comparisons <code><a href="../articles/feature-samplers.html">vignette("feature-samplers")</a></code> for more details
on implemented samplers.</p>
</div>
<div class="section level2">
<h2 id="detailed-scoring-information">Detailed Scoring Information<a class="anchor" aria-label="anchor" href="#detailed-scoring-information"></a>
</h2>
<p>All methods store detailed scoring information from each resampling
iteration for further analysis. Let’s examine the structure of PFI’s
detailed scores:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pfi</span><span class="op">$</span><span class="fu">scores</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">4</span>, caption <span class="op">=</span> <span class="st">"Detailed PFI scores (first 10 rows)"</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Detailed PFI scores (first 10 rows)</caption>
<colgroup>
<col width="16%">
<col width="12%">
<col width="15%">
<col width="23%">
<col width="17%">
<col width="14%">
</colgroup>
<thead><tr class="header">
<th align="left">feature</th>
<th align="right">iter_rsmp</th>
<th align="right">iter_repeat</th>
<th align="right">regr.mse_baseline</th>
<th align="right">regr.mse_post</th>
<th align="right">importance</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">important1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">4.3358</td>
<td align="right">8.4459</td>
<td align="right">4.1102</td>
</tr>
<tr class="even">
<td align="left">important2</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">4.3358</td>
<td align="right">10.9357</td>
<td align="right">6.6000</td>
</tr>
<tr class="odd">
<td align="left">important3</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">4.3358</td>
<td align="right">5.2284</td>
<td align="right">0.8926</td>
</tr>
<tr class="even">
<td align="left">important4</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">4.3358</td>
<td align="right">15.4558</td>
<td align="right">11.1200</td>
</tr>
<tr class="odd">
<td align="left">important5</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">4.3358</td>
<td align="right">6.5032</td>
<td align="right">2.1674</td>
</tr>
<tr class="even">
<td align="left">unimportant1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">4.3358</td>
<td align="right">4.3324</td>
<td align="right">-0.0033</td>
</tr>
<tr class="odd">
<td align="left">unimportant2</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">4.3358</td>
<td align="right">4.3681</td>
<td align="right">0.0323</td>
</tr>
<tr class="even">
<td align="left">unimportant3</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">4.3358</td>
<td align="right">4.4284</td>
<td align="right">0.0927</td>
</tr>
<tr class="odd">
<td align="left">unimportant4</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">4.3358</td>
<td align="right">4.3111</td>
<td align="right">-0.0247</td>
</tr>
<tr class="even">
<td align="left">unimportant5</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">4.3358</td>
<td align="right">4.1194</td>
<td align="right">-0.2163</td>
</tr>
</tbody>
</table>
<p>We can also summarize the scoring structure:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pfi</span><span class="op">$</span><span class="fu">scores</span><span class="op">(</span><span class="op">)</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>    features <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/duplicated.html" class="external-link">uniqueN</a></span><span class="op">(</span><span class="va">feature</span><span class="op">)</span>,</span>
<span>    resampling_folds <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/duplicated.html" class="external-link">uniqueN</a></span><span class="op">(</span><span class="va">iter_rsmp</span><span class="op">)</span>,</span>
<span>    permutation_iters <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/duplicated.html" class="external-link">uniqueN</a></span><span class="op">(</span><span class="va">iter_repeat</span><span class="op">)</span>,</span>
<span>    total_scores <span class="op">=</span> <span class="va">.N</span></span>
<span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt;    features resampling_folds permutation_iters total_scores</span></span>
<span><span class="co">#&gt;       &lt;int&gt;            &lt;int&gt;             &lt;int&gt;        &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:       10                3                 1           30</span></span></code></pre></div>
<p>So <code>$importance()</code> always gives us the aggregated
importances across multiple resampling- and permutation-/refitting
iterations, whereas <code>$scores()</code> gives you the individual
scores as calculated by the supplied <code>measures</code> and the
corresponding importance calculated from the difference of these scores
by default.</p>
<p>Analogously to <code>$importance()</code>, you can also use
<code>relation = "ratio"</code> here:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pfi</span><span class="op">$</span><span class="fu">scores</span><span class="op">(</span>relation <span class="op">=</span> <span class="st">"ratio"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">4</span>, caption <span class="op">=</span> <span class="st">"PFI scores using the ratio (first 10 rows)"</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>PFI scores using the ratio (first 10 rows)</caption>
<colgroup>
<col width="16%">
<col width="12%">
<col width="15%">
<col width="23%">
<col width="17%">
<col width="14%">
</colgroup>
<thead><tr class="header">
<th align="left">feature</th>
<th align="right">iter_rsmp</th>
<th align="right">iter_repeat</th>
<th align="right">regr.mse_baseline</th>
<th align="right">regr.mse_post</th>
<th align="right">importance</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">important1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">4.3358</td>
<td align="right">8.4459</td>
<td align="right">1.9480</td>
</tr>
<tr class="even">
<td align="left">important2</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">4.3358</td>
<td align="right">10.9357</td>
<td align="right">2.5222</td>
</tr>
<tr class="odd">
<td align="left">important3</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">4.3358</td>
<td align="right">5.2284</td>
<td align="right">1.2059</td>
</tr>
<tr class="even">
<td align="left">important4</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">4.3358</td>
<td align="right">15.4558</td>
<td align="right">3.5647</td>
</tr>
<tr class="odd">
<td align="left">important5</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">4.3358</td>
<td align="right">6.5032</td>
<td align="right">1.4999</td>
</tr>
<tr class="even">
<td align="left">unimportant1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">4.3358</td>
<td align="right">4.3324</td>
<td align="right">0.9992</td>
</tr>
<tr class="odd">
<td align="left">unimportant2</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">4.3358</td>
<td align="right">4.3681</td>
<td align="right">1.0075</td>
</tr>
<tr class="even">
<td align="left">unimportant3</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">4.3358</td>
<td align="right">4.4284</td>
<td align="right">1.0214</td>
</tr>
<tr class="odd">
<td align="left">unimportant4</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">4.3358</td>
<td align="right">4.3111</td>
<td align="right">0.9943</td>
</tr>
<tr class="even">
<td align="left">unimportant5</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">4.3358</td>
<td align="right">4.1194</td>
<td align="right">0.9501</td>
</tr>
</tbody>
</table>
</div>
<div class="section level2">
<h2 id="observation-wise-losses-and-importances">Observation-wise losses and importances<a class="anchor" aria-label="anchor" href="#observation-wise-losses-and-importances"></a>
</h2>
<p>For methods where importances are calculated based on
observation-level comparisons and with decomposable measures, we can
also retrieve observation-level information with
<code>$obs_loss()</code>, which works analogously to
<code>$scores()</code> and <code>$importances()</code> but even more
detailed:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pfi</span><span class="op">$</span><span class="fu">obs_loss</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;            feature iter_rsmp iter_repeat row_ids loss_baseline   loss_post</span></span>
<span><span class="co">#&gt;             &lt;char&gt;     &lt;int&gt;       &lt;int&gt;   &lt;int&gt;         &lt;num&gt;       &lt;num&gt;</span></span>
<span><span class="co">#&gt;    1:   important1         1           1       1     3.3403244  0.26184209</span></span>
<span><span class="co">#&gt;    2:   important1         1           1       9     0.4640003  0.00316609</span></span>
<span><span class="co">#&gt;    3:   important1         1           1      11     1.0938319 10.11218211</span></span>
<span><span class="co">#&gt;    4:   important1         1           1      12     2.0091331  2.28764800</span></span>
<span><span class="co">#&gt;    5:   important1         1           1      15    11.4484770 38.11092543</span></span>
<span><span class="co">#&gt;   ---                                                                     </span></span>
<span><span class="co">#&gt; 2996: unimportant5         3           1     290    16.8041217 16.80412169</span></span>
<span><span class="co">#&gt; 2997: unimportant5         3           1     294     0.4212832  0.45933049</span></span>
<span><span class="co">#&gt; 2998: unimportant5         3           1     295     8.0016602  7.86721528</span></span>
<span><span class="co">#&gt; 2999: unimportant5         3           1     296     0.2308082  0.26544478</span></span>
<span><span class="co">#&gt; 3000: unimportant5         3           1     298    18.8129904 18.81299041</span></span>
<span><span class="co">#&gt;       obs_importance</span></span>
<span><span class="co">#&gt;                &lt;num&gt;</span></span>
<span><span class="co">#&gt;    1:    -3.07848231</span></span>
<span><span class="co">#&gt;    2:    -0.46083425</span></span>
<span><span class="co">#&gt;    3:     9.01835017</span></span>
<span><span class="co">#&gt;    4:     0.27851489</span></span>
<span><span class="co">#&gt;    5:    26.66244838</span></span>
<span><span class="co">#&gt;   ---               </span></span>
<span><span class="co">#&gt; 2996:     0.00000000</span></span>
<span><span class="co">#&gt; 2997:     0.03804724</span></span>
<span><span class="co">#&gt; 2998:    -0.13444495</span></span>
<span><span class="co">#&gt; 2999:     0.03463658</span></span>
<span><span class="co">#&gt; 3000:     0.00000000</span></span></code></pre></div>
<p>Since we computed PFI using the mean squared error
(<code>msr("regr.mse")</code>), we can use the associated
<code>Measure$obs_loss()</code>, the squared error.<br>
In the resulting table we see</p>
<ul>
<li>
<code>loss_baseline</code>: The loss (squared error) for the
baseline model before permutation</li>
<li>
<code>loss_post</code>: The loss for this observation after
permutation (or in the case of <code>LOCO</code>, after refit)</li>
<li>
<code>obs_importance</code>: The difference (or ratio if
<code>relation = "ratio"</code>) of the the two losses</li>
</ul>
<p>Note that not all measures have a <code>Measure$obs_loss()</code>:
Some measures like <code>msr("classif.auc")</code> are not decomposable,
so observation-wise loss values are not available.<br>
In other cases, the corresponding <code>obs_loss()</code> is just not
yet implemented in <a href="https://cran.r-project.org/web/packages/mlr3measures/index.html" class="external-link"><code>mlr3measures</code></a>,
but will likely be in the future.</p>
</div>
<div class="section level2">
<h2 id="parallelization">Parallelization<a class="anchor" aria-label="anchor" href="#parallelization"></a>
</h2>
<p>Both PFI/CFI/RFI and LOCO/WVIM support parallel execution to speed up
computation when working with multiple features or expensive learners.
The parallelization follows mlr3’s approach, allowing users to choose
between <code>mirai</code> and <code>future</code> backends.</p>
<div class="section level3">
<h3 id="example-with-future">Example with future<a class="anchor" aria-label="anchor" href="#example-with-future"></a>
</h3>
<p>The <code>future</code> package provides a simple interface for
parallel and distributed computing:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="st">"multisession"</span>, workers <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># PFI with parallelization across features</span></span>
<span><span class="va">pfi_parallel</span> <span class="op">=</span> <span class="va"><a href="../reference/PFI.html">PFI</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    <span class="va">task</span>,</span>
<span>    learner <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">lrn</a></span><span class="op">(</span><span class="st">"regr.ranger"</span><span class="op">)</span>,</span>
<span>    measure <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">msr</a></span><span class="op">(</span><span class="st">"regr.mse"</span><span class="op">)</span>,</span>
<span>    n_repeats <span class="op">=</span> <span class="fl">10</span></span>
<span><span class="op">)</span></span>
<span><span class="va">pfi_parallel</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">pfi_parallel</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># LOCO with parallelization (uses mlr3fselect internally)</span></span>
<span><span class="va">loco_parallel</span> <span class="op">=</span> <span class="va"><a href="../reference/LOCO.html">LOCO</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    <span class="va">task</span>,</span>
<span>    learner <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">lrn</a></span><span class="op">(</span><span class="st">"regr.ranger"</span><span class="op">)</span>,</span>
<span>    measure <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">msr</a></span><span class="op">(</span><span class="st">"regr.mse"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">loco_parallel</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">loco_parallel</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="example-with-mirai">Example with mirai<a class="anchor" aria-label="anchor" href="#example-with-mirai"></a>
</h3>
<p>The <code>mirai</code> package offers a modern alternative for
parallel computing:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mirai.r-lib.org" class="external-link">mirai</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://mirai.r-lib.org/reference/daemons.html" class="external-link">daemons</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Same PFI/LOCO code works with mirai backend</span></span>
<span><span class="va">pfi_parallel</span> <span class="op">=</span> <span class="va"><a href="../reference/PFI.html">PFI</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    <span class="va">task</span>,</span>
<span>    learner <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">lrn</a></span><span class="op">(</span><span class="st">"regr.ranger"</span><span class="op">)</span>,</span>
<span>    measure <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">msr</a></span><span class="op">(</span><span class="st">"regr.mse"</span><span class="op">)</span>,</span>
<span>    n_repeats <span class="op">=</span> <span class="fl">10</span></span>
<span><span class="op">)</span></span>
<span><span class="va">pfi_parallel</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">pfi_parallel</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Clean up daemons when done</span></span>
<span><span class="fu"><a href="https://mirai.r-lib.org/reference/daemons.html" class="external-link">daemons</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="notes">Notes<a class="anchor" aria-label="anchor" href="#notes"></a>
</h3>
<ul>
<li>
<strong>SAGE</strong>: Currently does not support parallelization
and will always run sequentially</li>
<li>
<strong>Performance</strong>: Parallelization is most beneficial
with multiple features, large datasets, or expensive learners</li>
<li>
<strong>Backend choice</strong>: Use either
<code><a href="https://future.futureverse.org/reference/plan.html" class="external-link">future::plan()</a></code> or <code><a href="https://mirai.r-lib.org/reference/daemons.html" class="external-link">mirai::daemons()</a></code> - both work
with the same code</li>
<li>
<strong>Consistency</strong>: Both PerturbationImportance
(PFI/CFI/RFI) and WVIM (LOCO) use the same mlr3 parallelization
infrastructure</li>
</ul>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://lukasburk.de" class="external-link">Lukas Burk</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
